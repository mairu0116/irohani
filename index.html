<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ã„ã‚ã¯ã«å¥”èµ° - ã¿ã‚“ãªã§æ¥½ã—ãæ–‡å­—å½“ã¦ã‚²ãƒ¼ãƒ ï¼</title>
<link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho+B1:wght@400;700;900&family=Yuji+Syuku&display=swap" rel="stylesheet">
<style>
  /* ===== å’Œé¢¨ãƒ†ãƒ¼ãƒï¼ˆç´™ãƒ»å¢¨ãƒ»è—ãƒ»æœ±ãƒ»é‡‘ï¼‰ ===== */
  :root{
    --paper:#f7f4e9; --paper2:#f2efe6; --ink:#27231f; --muted:#6f675f;
    --indigo:#1a2c42; --vermilion:#b3352e; --asagi:#6f9dbb; --gold:#c8a44d;
    --ok:#7b955b; --warn:#b58b3a; --err:#a04b4b;

    /* === 1080-fit: èª¿æ•´ç”¨ï¼ˆPCãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ === */
    --containerW: 1480px;
    --gap: 10px;
    --panelPad: 12px;
    --panelMar: 8px;
    --headerH: 84px;
    --topRowH: 130px;
    --sideW: 420px;
    --tileH: 48px;   /* PC: ãƒœãƒ¼ãƒ‰ã®ã‚¿ã‚¤ãƒ«é«˜ã•ï¼ˆæ§ãˆã‚ï¼‰ */
    --headH: 42px;   /* PC: è¡Œ/åˆ—ãƒ˜ãƒƒãƒ€é«˜ã• */
    --fontBase: 15px;
    --fontTitle: 30px;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family:"Shippori Mincho B1","Hiragino Mincho ProN","Yu Mincho","Noto Serif JP",serif;
    background:
      radial-gradient(1100px 780px at 10% -10%, rgba(26,44,66,.06) 0%, transparent 60%),
      radial-gradient(900px 700px at 110% 20%, rgba(179,53,46,.05) 0%, transparent 60%),
      linear-gradient(180deg, var(--paper) 0%, var(--paper2) 100%);
    overflow-x:hidden;
    font-size: var(--fontBase);
    -webkit-tap-highlight-color: rgba(0,0,0,0);
  }
  .bg-dots::before{
    content:""; position:fixed; inset:0; pointer-events:none; opacity:.14; mix-blend-mode:multiply;
    background:
      radial-gradient(closest-side, rgba(26,44,66,.10) 80%, transparent 81%) 0 0/32px 32px,
      radial-gradient(closest-side, rgba(26,44,66,.10) 80%, transparent 81%) 16px 16px/32px 32px;
  }

  /* === 1080-fit: ã‚³ãƒ³ãƒ†ãƒŠãƒ»åŸºæœ¬é–“éš”ï¼ˆPCï¼‰ === */
  .container{max-width:var(--containerW);margin:0 auto;padding:16px}
  header{display:flex; align-items:center; justify-content:space-between; gap:10px; margin:2px 0 10px; min-height:var(--headerH)}
  .logo{display:flex; gap:10px; align-items:center}
  .logo-emoji{font-size:22px; filter: drop-shadow(0 1px 0 rgba(255,255,255,.6));}
  h1{margin:0; font-family:"Yuji Syuku", serif; letter-spacing:.08em; font-size:var(--fontTitle); line-height:1.1; color:var(--indigo); text-shadow:0 1px 0 rgba(255,255,255,.45)}
  h1::after{content:""; display:block; width:140px; height:6px; margin-top:4px; border-radius:999px;
    background: linear-gradient(90deg, var(--vermilion), rgba(179,53,46,.45));}
  .subtitle{margin-top:2px; color:var(--muted); font-size:11px}

  .panel{
    background:
      linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,.35)),
      radial-gradient(1200px 800px at 80% -10%, rgba(200,164,77,.08), transparent 60%);
    border:1px solid rgba(39,35,31,.22); border-radius:12px; padding:var(--panelPad); margin:var(--panelMar) 0;
    box-shadow: 0 2px 0 rgba(0,0,0,.04), 0 8px 24px rgba(0,0,0,.06);
  }
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .grid{display:grid;gap:var(--gap)}
  .cols-2{grid-template-columns:1fr 1fr}
  .cols-3{grid-template-columns:repeat(3, 1fr)}
  @media (max-width:900px){ .cols-3{grid-template-columns:1fr} }
  input,button{background:rgba(255,255,255,.7);color:var(--ink);border:1px solid rgba(39,35,31,.24);border-radius:10px;padding:8px 10px}
  input{min-width:220px; font-family:inherit}
  button{cursor:pointer;font-weight:700;letter-spacing:.06em; transition: transform .08s ease, filter .12s ease, box-shadow .12s ease; touch-action: manipulation}
  button:active{transform:translateY(1px) scale(.99)}
  .primary{background:linear-gradient(180deg, #23384f, #1a2c42); color:#faf7ed; border-color:#132334; box-shadow: 0 4px 12px rgba(26,44,66,.25)}
  .danger{background:linear-gradient(180deg, #8f2d27, #7a221d); color:#fff7f2; border-color:#5f1d18; box-shadow: 0 4px 12px rgba(179,53,46,.22)}
  .success{background:linear-gradient(180deg, #6a8551, #556e42); color:#f7fff2; border-color:#445c35; box-shadow: 0 4px 12px rgba(85,110,66,.22)}
  .ghost{background:transparent}
  .hint{color:var(--muted);font-size:12px;margin-top:4px}
  .kbd{border:1px solid rgba(39,35,31,.28);padding:1px 6px;border-radius:6px;background:rgba(0,0,0,.04);font-family:ui-monospace,monospace;font-size:12px}
  .pill{font-size:10px;padding:5px 9px;border-radius:999px;background:#efe8d8;border:1px solid rgba(200,164,77,.55);color:#6a5f51}

  .players{display:flex;gap:8px;flex-wrap:wrap}
  .player{display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid rgba(39,35,31,.18);border-radius:12px;background:linear-gradient(180deg, #fffdf6, #f4eedf)}
  .player.active{outline:2px solid var(--gold); box-shadow: 0 0 0 4px rgba(200,164,77,.18); animation: bump .8s ease}
  .dot{width:8px;height:8px;border-radius:50%; background:linear-gradient(180deg,var(--vermilion),#e08378); box-shadow:0 0 0 2px rgba(179,53,46,.18)}
  @keyframes bump{0%{transform:scale(1)}30%{transform:scale(1.06)}100%{transform:scale(1)}}

  /* ===== ãƒœãƒ¼ãƒ‰ï¼ˆPCï¼šå°‘ã—å°ã•ã‚ï¼‰ ===== */
  .board-wrap h3{margin:0 0 6px}
  .board-grid{
    display:grid;
    grid-template-columns: 64px repeat(5, 1fr); /* PCã¯æ¯”ç‡ã§åºƒãŒã‚‹ */
    column-gap:8px; row-gap:6px;
    align-items:stretch;
  }
  .head, .rowlabel{
    display:flex; align-items:center; justify-content:center;
    font-weight:900; letter-spacing:.12em; color:#1a2c42;
    background:linear-gradient(180deg,#f6f1de,#efe6cd);
    border:1px solid rgba(39,35,31,.22); border-radius:10px; padding:0 4px; height:var(--headH);
    box-shadow: 0 2px 10px rgba(0,0,0,.06); font-size:13px;
  }
  .rowlabel{ background:linear-gradient(180deg,#fffaf0,#f1e5c9); }
  .tile{
    position:relative; height:var(--tileH); display:flex; align-items:center; justify-content:center;
    border:1px solid rgba(39,35,31,.22);border-radius:10px;user-select:none;
    background:linear-gradient(180deg,#f0e5cf,#e5d1a0); font-weight:900; letter-spacing:.12em; color:#2a2622;
    text-shadow:0 1px 0 rgba(255,255,255,.65); box-shadow: 0 6px 16px rgba(0,0,0,.12);
    transition: transform .08s ease, box-shadow .12s ease, filter .12s ease, opacity .2s ease;
    font-size:20px;
  }
  .tile.clickable{cursor:pointer}
  .tile.clickable:hover{transform: translateY(-2px); box-shadow: 0 10px 24px rgba(0,0,0,.18)}
  .tile.idle{opacity:.9}
  .tile.used{opacity:.5; filter: grayscale(.1)}
  .tile.used::after{content:"æ¸ˆ"; position:absolute; inset:auto 6px 6px auto; font-size:10px; padding:2px 6px; border-radius:999px; background:#fff2ef; color:var(--vermilion);
    border:1px solid rgba(179,53,46,.45); box-shadow: inset 0 0 0 2px rgba(179,53,46,.12)}
  .tile.placeholder{
    background: repeating-linear-gradient(45deg, rgba(26,44,66,.06) 0 6px, rgba(26,44,66,.02) 6px 12px);
    color:#8b7f71; opacity:.6; font-size:16px
  }

  /* ã‚«ãƒ¼ãƒ‰ï¼ˆPCï¼šå°‘ã—å°ã•ãï¼‰ */
  .cards{display:flex;gap:8px;flex-wrap:wrap}
  .card{width:46px;height:66px;border-radius:10px;border:1px solid rgba(39,35,31,.22);display:flex;align-items:center;justify-content:center;
        background:linear-gradient(180deg,#fff8e9,#f1e3cc);position:relative; box-shadow: 0 6px 18px rgba(0,0,0,.16); font-weight:900; color:var(--ink); font-size:16px}
  .card.x{opacity:.85}
  .card.revealed{outline:2px solid var(--ok); box-shadow: 0 0 0 4px rgba(123,149,91,.18)}
  .card.hidden::after{content:"";position:absolute;inset:0;border-radius:10px;
    background:
      repeating-linear-gradient(45deg, rgba(26,44,66,.1) 0 6px, transparent 6px 12px),
      linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,.35));}
  .me{outline:2px dashed rgba(200,164,77,.5); padding:10px; border-radius:12px;}

  .footer{margin-top:12px;color:var(--muted);font-size:12px;text-align:center}

  .topic-chip{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-weight:800; color:#fff;
    background:linear-gradient(135deg, var(--vermilion), #d25a52); border:1px solid rgba(179,53,46,.55);
    box-shadow: 0 4px 14px rgba(179,53,46,.2); font-size:14px}
  .topic-chip .emoji{font-size:16px}

  .turn-banner{display:flex; align-items:center; justify-content:center; gap:8px; font-weight:900; padding:8px 10px; border-radius:10px;
    background:linear-gradient(135deg, rgba(111,157,187,.18), rgba(200,164,77,.12)); border:1px solid rgba(26,44,66,.25); color:#1a2c42; font-size:14px}
  .turn-banner .blink{animation: blink 1.2s steps(2,end) infinite}
  @keyframes blink { 50%{opacity:.35} }

  .myturn{ box-shadow: 0 0 0 3px rgba(179,53,46,.18) inset, 0 0 0 2px rgba(179,53,46,.36); }

  .toast{position:fixed; top:14px; right:14px; z-index:99; display:flex; flex-direction:column; gap:6px}
  .toast .t{background:#fbfaf5; border:1px solid rgba(39,35,31,.18); padding:8px 10px; border-radius:10px; box-shadow: 0 6px 16px rgba(0,0,0,.08); font-weight:800; color:var(--ink)}
  .t.ok{border-color: rgba(123,149,91,.6)}
  .t.ng{border-color: rgba(160,75,75,.6)}

  #fx{position:fixed; inset:0; pointer-events:none; z-index:90}

  .secret-panel{border:2px dashed rgba(200,164,77,.7); background:rgba(255,255,240,.6)}
  .secret-title{font-weight:900; color:var(--indigo); margin-bottom:4px}

  /* === è‡ªåˆ†ã®æ‰‹ç•ªãƒãƒŠãƒ¼ === */
  .turn-me{
    position:fixed; top:12px; left:50%; transform:translateX(-50%);
    z-index:95; padding:8px 12px; border-radius:10px; font-weight:900;
    background:linear-gradient(135deg, rgba(179,53,46,.12), rgba(200,164,77,.18));
    border:1px solid rgba(179,53,46,.45); color:#7a221d;
    box-shadow: 0 8px 24px rgba(0,0,0,.12), 0 0 0 4px rgba(179,53,46,.08);
    animation: ping 1.2s ease-in-out infinite; font-size:14px
  }
  @keyframes ping { 0%,100% { filter:brightness(1); } 50% { filter:brightness(1.12); } }
  body.itsmyturn .board-wrap{ outline:2px solid rgba(179,53,46,.3); outline-offset:2px; }

  /* === 1080-fit: ã‚²ãƒ¼ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆPCï¼‰ === */
  .game-layout{
    display:grid;
    grid-template-columns: 1fr var(--sideW);
    grid-auto-rows: min-content;
    gap: var(--gap);
    align-items: start;
  }
  .top-row{ grid-column: 1 / -1; display:grid; grid-template-columns: repeat(3, 1fr); gap: var(--gap); min-height: var(--topRowH); }
  .side-stack{ display:grid; grid-auto-rows: min-content; gap: var(--gap); }

  /* å†…å´ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã®è¦‹åˆ‡ã‚Œå¯¾ç­– */
  .panel.scrollable{ overflow:auto; }

  /* === ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–ï¼ˆiPhoneã‚’æ„è­˜ï¼‰ ======================= */

  /* 1) ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ/å°å‹æ¨ªå¹…ï¼š1ã‚«ãƒ©ãƒ ã«ã—ã¦ä½™è£•ã‚’ä½œã‚‹ */
  @media (max-width: 900px){
    .game-layout{ grid-template-columns: 1fr; }
    .top-row{ grid-template-columns: 1fr; }
    :root{ --sideW: 100% }
    .container{ padding:12px }
  }

  /* 2) å¹…768pxä»¥ä¸‹ï¼šãƒœãƒ¼ãƒ‰ã‚’å›ºå®šå¹…ï¼‹æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã«å¤‰æ›´ï¼ˆã‚¿ãƒƒãƒ—å¤§ãã‚ï¼‰ */
  @media (max-width: 768px){
    :root{ --tileH: 56px; --headH: 50px }
    .board-grid{
      /* è¡Œãƒ©ãƒ™ãƒ« 60px + 5åˆ—Ã—64pxã€ã‚®ãƒ£ãƒƒãƒ—8pxã‚’ç¢ºä¿ */
      grid-template-columns: 60px repeat(5, 64px);
      /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç”¨ã®å›ºå®šç·å¹…ï¼ˆç›®å®‰ï¼‰ï¼š60 + 5*64 + 8*5 = 420px */
      min-width: 420px;
    }
    .board-wrap{ overflow-x:auto; -webkit-overflow-scrolling: touch; }
    .tile{ font-size:22px }
    .head, .rowlabel{ font-size:13px }
  }

  /* 3) å¹…480pxä»¥ä¸‹ï¼šiPhone ç¸¦æŒã¡ã®æ¨™æº–çš„ãªã‚±ãƒ¼ã‚¹ */
  @media (max-width: 480px){
    :root{ --tileH: 60px; --headH: 54px; --panelPad: 10px; --gap:8px }
    .container{ padding:10px }
    .subtitle{ display:none }
    #bgmVolume{ display:none } /* æ¥µå°ç”»é¢ã§éŸ³é‡ã‚¹ãƒ©ã‚¤ãƒ€éè¡¨ç¤º */

    .board-grid{
      /* è¡Œãƒ©ãƒ™ãƒ« 56px + 5åˆ—Ã—60pxã€ã‚®ãƒ£ãƒƒãƒ—8px */
      grid-template-columns: 56px repeat(5, 60px);
      min-width: 56px + (60px * 5) + (8px * 5); /* è¨ˆç®—å¼ã®ã‚³ãƒ¡ãƒ³ãƒˆã€å®Ÿéš›ã®å¹…ã¯ãƒ–ãƒ©ã‚¦ã‚¶è¨ˆç®— */
    }
    .board-wrap{ overflow-x:auto; -webkit-overflow-scrolling: touch; }
    .tile{ font-size:22px }
    .tile.used::after{ font-size:10px; padding:2px 6px }
    .head, .rowlabel{ font-size:13px }
  }

  /* 4) å¹…390pxä»¥ä¸‹ï¼šiPhone mini ç­‰ã•ã‚‰ã«ç‹­ã„å ´åˆ */
  @media (max-width: 390px){
    :root{ --tileH: 58px; --headH: 52px }
    .board-grid{
      /* è¡Œãƒ©ãƒ™ãƒ« 52px + 5åˆ—Ã—58pxã€ã‚®ãƒ£ãƒƒãƒ—6pxã«å°‘ã—è©°ã‚ã‚‹ */
      column-gap:6px;
      grid-template-columns: 52px repeat(5, 58px);
      min-width: 52px + (58px * 5) + (6px * 5);
    }
    .tile{ font-size:21px }
  }
</style>
</head>
<body class="bg-dots">
<div id="fx"></div>
<div class="container">
  <header>
    <div class="logo">
      <div class="logo-emoji">ğŸ´ğŸ®</div>
      <div>
        <h1>ã„ã‚ã¯ã«å¥”èµ°</h1>
        <div class="subtitle">ãŠã—ï½ã£ã“ã®å€«ç†è¦³</div>
      </div>
    </div>

    <button id="soundToggle" class="pill ghost" title="SEåˆ‡æ›¿">ğŸ”Š SE ON</button>
    <button id="bgmToggle" class="pill ghost" title="BGMåˆ‡æ›¿">ğŸµ BGM ON</button>
    <input id="bgmVolume" type="range" min="0" max="100" value="50" title="BGMéŸ³é‡" style="vertical-align:middle;width:120px;">
  </header>

  <div id="app" class="grid"></div>
  <p class="footer">ãƒã‚¿ãƒ¼ãŒçµ¡ã¿ã¤ã„ã¦ã€ã„ã‚„ã ã­ãˆ</p>
</div>
<div class="toast" id="toast"></div>

<!-- Firebase CDNï¼ˆç•¥ï¼‰ -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script>
/*** ã“ã“ã‚’ã‚ãªãŸã®Firebaseæ§‹æˆã«ç½®ãæ›ãˆ ***/
const firebaseConfig = {
  apiKey: "AIzaSyDxt9FCqPYwGMx1brd1oWOSXxqqeajEkiE",
  authDomain: "irohani-48cf2.firebaseapp.com",
  projectId: "irohani-48cf2",
  storageBucket: "irohani-48cf2.firebasestorage.app",
  messagingSenderId: "917468195405",
  appId: "1:917468195405:web:501559a87a364f67488a04"
};
/*** ä»¥ä¸Š ***/

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ä»¥é™ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯å‰å›ã¨åŒä¸€ï¼ˆå‹è€…ç´™å¹é›ªã®å®Œå…¨åœæ­¢ã€ãƒ­ãƒƒã‚¯è§£é™¤ã€æ‰‹ç•ªãƒãƒŠãƒ¼ã€å‹è€…å…¨é–‹ç¤ºãªã©ç¶­æŒï¼‰ */
/* --- ç•¥ã›ãªã„éƒ¨åˆ†ã®ã¿æŠœç²‹/åŒä¸€è¨˜è¿° --- */

/* ä¾¿åˆ©é–¢æ•° */
const uid = () => localStorage.getItem('irohani_uid') || (localStorage.setItem('irohani_uid', Math.random().toString(36).slice(2,10)), localStorage.getItem('irohani_uid'));
const now = () => Date.now();
const qs = new URLSearchParams(location.search);

/* Toast */
function showToast(msg, ok=true){
  const wrap = document.getElementById('toast');
  const el = document.createElement('div'); el.className = 't ' + (ok ? 'ok' : 'ng');
  el.textContent = msg; wrap.appendChild(el);
  setTimeout(()=>{ el.style.transition='opacity .3s ease, transform .3s ease'; el.style.opacity='0'; el.style.transform='translateY(-6px)'; }, 1500);
  setTimeout(()=> wrap.removeChild(el), 1900);
}

/* ç´™å¹é›ªãƒ«ãƒ¼ãƒ—ï¼ˆåŒä¸€ï¼‰ */
let CONFETTI_RAF = 0, CONFETTI_CANVAS = null, CONFETTI_RUNNING = false;
function startConfettiLoop(pieces=140){ /* â€¦åŒä¸€â€¦ */ }
function stopConfettiLoop(){ /* â€¦åŒä¸€â€¦ */ }

/* ã²ã‚‰ãŒãªæ­£è¦åŒ–ãªã©å®šç¾©ï¼ˆåŒä¸€ï¼‰ */
const mapDakuten = Object.fromEntries([/* â€¦åŒä¸€â€¦ */]);
const mapSmall   = Object.fromEntries([/* â€¦åŒä¸€â€¦ */]);
function toHiragana(s){ /* â€¦åŒä¸€â€¦ */ }
function normWord(input){ /* â€¦åŒä¸€â€¦ */ }

/* ã‚°ãƒªãƒƒãƒ‰/ãŠé¡Œï¼ˆåŒä¸€ï¼‰ */
const VOWELS = ['ã‚','ã„','ã†','ãˆ','ãŠ'];
const ROWS = [/* â€¦åŒä¸€â€¦ */];
const TOPICS = [/* â€¦åŒä¸€â€¦ */];
async function setTopic(roomId){ /* â€¦åŒä¸€â€¦ */ }

/* è‰ç¨¿ä¿å­˜ï¼ˆåŒä¸€ï¼‰ */
function draftKey(roomId, uid){ return `irohani_draft_${roomId}_${uid}`; }
function getDraft(roomId, uid){ try { return localStorage.getItem(draftKey(roomId, uid)) || ''; } catch{ return ''; } }
function setDraft(roomId, uid, val){ try { localStorage.setItem(draftKey(roomId, uid), val||''); } catch{} }
function clearDraft(roomId, uid){ try { localStorage.removeItem(draftKey(roomId, uid)); } catch{} }

/* çŠ¶æ…‹ãªã©ï¼ˆåŒä¸€ï¼‰ */
const state = { screen:'lobby', roomId:'', myUid:uid(), name:'', roomRef:null, roomSnap:null, lastSeenAttackTs:0, didConfetti:false };

/* join / subscribe / lock / unlock / start / nextAlive / checkDropAndWinner / attack / restartï¼ˆåŒä¸€ï¼‰ */
/* â€¦å…¨é–¢æ•°ã¯ä»¥å‰ã®ã‚³ãƒ¼ãƒ‰ã¨åŒä¸€ã§ã™â€¦ */

/* æ‰‹ç•ªã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ï¼ˆåŒä¸€ï¼‰ */
function updateTurnIndicators(myTurn){ /* â€¦åŒä¸€â€¦ */ }

const $ = s => document.querySelector(s);
function cardNode(ch, revealed, isMe){ /* â€¦åŒä¸€â€¦ */ }

function renderLobby(){ /* â€¦åŒä¸€â€¦ */ }
function renderRoom(){ /* â€¦åŒä¸€â€¦ */ }

/* === 1080-fit: é«˜ã•è¨ˆç®—ï¼ˆPC/ãƒ¢ãƒã‚¤ãƒ«ä¸¡å¯¾å¿œï¼‰ === */
function fitLayoutHeights(){
  const vh = window.innerHeight || 1080;
  const header = document.querySelector('header');
  const topRow = document.querySelector('.top-row');
  const boardWrap = document.querySelector('.board-wrap');
  const others = document.getElementById('panel-others');
  const mine = document.getElementById('panel-mine');

  if (!header || !topRow || !boardWrap) return;

  const headH = header.offsetHeight || 84;
  const topH  = topRow.offsetHeight || 130;
  const paddings = 16 + 16;
  const footer = 20;

  const remain = Math.max(360, vh - headH - topH - paddings - footer - 8);

  /* ãƒ‘ãƒãƒ«ã®é«˜ã•ï¼ˆãƒ¢ãƒã‚¤ãƒ«ã§ã‚‚å†…å´ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ï¼‰ */
  const boardH = Math.min(740, Math.max(420, remain));
  boardWrap.style.maxHeight = boardH + 'px';
  boardWrap.classList.add('scrollable');          // ç¸¦ãƒ»æ¨ªã¨ã‚‚ã«å¿…è¦ã«å¿œã˜ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  boardWrap.style.overflowX = 'auto';             // ãƒ¢ãƒã‚¤ãƒ«ã§ã®æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æ˜ç¤º
  boardWrap.style.webkitOverflowScrolling = 'touch';

  if (others){
    others.style.maxHeight = Math.floor(remain * 0.58) + 'px';
    others.classList.add('scrollable');
  }
  if (mine){
    mine.style.maxHeight = Math.floor(remain * 0.42) + 'px';
    mine.classList.add('scrollable');
  }
}

function renderGame(){
  const root = $('#app'); root.innerHTML='';
  const room = state.roomSnap?.val(); if (!room) return;
  if (!room.started) { state.screen='room'; render(); return; }

  const me = (room.players||{})[state.myUid]||{};
  const myTurn = room.currentTurnUid===state.myUid && !room.winnerUid;

  if (state.didConfetti && (!room.winnerUid)){ state.didConfetti=false; stopConfettiLoop(); }
  updateTurnIndicators(myTurn);

  const layout = document.createElement('div'); layout.className='game-layout';

  /* ä¸Šæ®µï¼šãŠé¡Œ / é€²è¡ŒçŠ¶æ³ / æ“ä½œ */
  const topRow = document.createElement('div'); topRow.className='top-row';

  const topic = document.createElement('div'); topic.className='panel';
  topic.innerHTML = `<div class="hint">ãŠé¡Œ</div><div class="topic-chip"><span class="emoji">ğŸ¯</span><span>${room.topic||'â€”'}</span></div>`;
  topRow.appendChild(topic);

  const status = document.createElement('div'); status.className='panel';
  if (room.winnerUid){
    status.innerHTML = `<h3 style="color:var(--ok); margin:0 0 6px">ğŸ† å‹è€…ï¼š${room.players[room.winnerUid]?.name||'ï¼Ÿï¼Ÿï¼Ÿ'}</h3>`;
    if (!state.didConfetti){ state.didConfetti = true; startConfettiLoop(); }
  }else{
    status.innerHTML = `<div class="turn-banner"><span class="blink">â³</span> æ‰‹ç•ªï¼š<strong>${room.players[room.currentTurnUid]?.name||'â€”'}</strong> <span class="pill">${room.consec===1?'ã‚ã¨1å›æ”»æ’ƒå¯':'æœ€å¤§2é€£ã¾ã§'}</span></div>`;
    if (room.lastAttack){
      const la = room.lastAttack;
      const who = room.players[la.by]?.name||'â€”';
      status.innerHTML += `<div class="hint" style="margin-top:6px">ç›´å‰ï¼š${who}ã€Œ${la.kana}ã€â†’${la.success?'æˆåŠŸ':'å¤±æ•—'}</div>`;
      if (la.ts && la.ts !== state.lastSeenAttackTs){
        state.lastSeenAttackTs = la.ts;
        showToast(`${who} ãŒã€Œ${la.kana}ã€ã‚’å®£è¨€ â€” ${la.success? 'ğŸ¯ ã‚ãŸã‚Šï¼' : 'ğŸ’¥ ã¯ãšã‚Œâ€¦'}`, la.success);
      }
    }
  }
  topRow.appendChild(status);

  const actions = document.createElement('div'); actions.className='panel';
  const restartBtn = document.createElement('button');
  restartBtn.className='danger';
  restartBtn.textContent='ğŸ” ãƒªã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆåŒã˜é¢å­ï¼‰';
  restartBtn.onclick = async ()=>{
    if (confirm('æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ')) {
      await restart(state.roomId);
      state.screen = 'room';
      render();
    }
  };
  actions.appendChild(restartBtn);
  actions.appendChild(Object.assign(document.createElement('div'),{className:'hint',innerHTML:'æ”»æ’ƒã¯è‡ªåˆ†ã®ç•ªã«ãƒœãƒ¼ãƒ‰ã®æ–‡å­—ã‚’ã‚¿ãƒƒãƒ—ã€‚æˆåŠŸã™ã‚‹ã¨ã‚‚ã†1å›ã ã‘ç¶šã‘ã‚‰ã‚Œã¾ã™ã€‚'}));
  topRow.appendChild(actions);

  layout.appendChild(topRow);

  /* å·¦ï¼šãƒœãƒ¼ãƒ‰ */
  const boardWrap = document.createElement('div'); boardWrap.className='panel board-wrap' + (myTurn ? ' myturn' : '');
  boardWrap.innerHTML = `<h3>å ´ã®ãƒœãƒ¼ãƒ‰ï¼ˆäº”åéŸ³é †ï¼‰</h3>`;
  const grid = document.createElement('div'); grid.className='board-grid';

  const headBlank = document.createElement('div'); headBlank.className='head'; headBlank.textContent='è¡Œ';
  grid.appendChild(headBlank);
  VOWELS.forEach(v=>{ const h = document.createElement('div'); h.className='head'; h.textContent=v; grid.appendChild(h); });

  const usedMap = room.used || {};
  const makeTile = (kana)=>{
    const already = !!usedMap[kana];
    const canClick = myTurn && !already;
    const t = document.createElement('div');
    t.className = 'tile ' + (already ? 'used' : (canClick ? 'clickable' : 'idle'));
    t.textContent = kana;
    if (canClick){ t.onclick = ()=> attack(state.roomId, state.myUid, kana); }
    return t;
  };

  ROWS.forEach(row=>{
    const label = document.createElement('div'); label.className='rowlabel'; label.textContent=row.label;
    grid.appendChild(label);
    row.cells.forEach(cell=>{
      if (!cell){ const ph = document.createElement('div'); ph.className='tile placeholder'; ph.textContent='â€”'; grid.appendChild(ph); }
      else{ grid.appendChild(makeTile(cell)); }
    });
  });

  boardWrap.appendChild(grid);

  /* å³ï¼šä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ / è‡ªåˆ†ã®æ‰‹æœ­ï¼ˆãƒ¢ãƒã‚¤ãƒ«ã§ã¯ä¸‹ã«å›ã‚‹ï¼‰ */
  const side = document.createElement('div'); side.className='side-stack';

  const others = document.createElement('div'); others.className='panel'; others.id='panel-others';
  others.innerHTML = `<h3 style="margin:0 0 6px">ä»–ã®å¾¡æ–¹</h3>`;
  const list = document.createElement('div'); list.className='players';
  for (const [pid,p] of Object.entries(room.players||{})){
    if (pid===state.myUid) continue;
    const d = document.createElement('div'); d.className='player'+(p.dropped?'':'');
    if (room.currentTurnUid===pid && !room.winnerUid) d.classList.add('active');
    d.innerHTML = `<span class="dot"></span><strong>${p.name}</strong> ${p.dropped?'<span class="pill">è„±è½</span>':''}`;
    const hand = document.createElement('div'); hand.className='cards';
    (p.word||[]).forEach((ch,i)=>{ hand.appendChild(cardNode(ch, (p.revealed||[])[i], false)); });
    d.appendChild(hand);
    list.appendChild(d);
  }
  others.appendChild(list);

  const mine = document.createElement('div'); mine.className='panel'; mine.id='panel-mine';
  mine.innerHTML = `<h3 style="margin:0 0 6px">è‡ªåˆ†ã®æ‰‹æœ­</h3>`;
  const myhand = document.createElement('div'); myhand.className='cards me';
  (me.word||[]).forEach((ch,i)=>{ myhand.appendChild(cardNode(ch, (me.revealed||[])[i], true)); });
  mine.appendChild(myhand);
  mine.appendChild(Object.assign(document.createElement('div'),{className:'hint',innerHTML:'Ã—ã¯ç©ºç™½ã‚«ãƒ¼ãƒ‰ã€‚å…¬é–‹æ¡ä»¶ï¼šå®£è¨€æ–‡å­—ã«ä¸€è‡´ã—ãŸã‚«ãƒ¼ãƒ‰ï¼ˆåŒã˜æ–‡å­—ãŒè¤‡æ•°ã‚ã‚Œã°å…¨éƒ¨å…¬é–‹ï¼‰ã€‚Ã—ä»¥å¤–ãŒå…¨éƒ¨å…¬é–‹ã§è„±è½ã€‚'}));

  side.appendChild(others);
  side.appendChild(mine);

  layout.appendChild(boardWrap);
  layout.appendChild(side);

  const root = document.getElementById('app');
  root.appendChild(layout);

  fitLayoutHeights();
}

function render(){
  if (state.screen==='lobby') return renderLobby();
  if (state.screen==='room') return renderRoom();
  if (state.screen==='game') {
    const r = renderGame();
    window.onresize = ()=>{ try{ fitLayoutHeights(); }catch(e){} };
    return r;
  }
}

/* åˆæœŸè¡¨ç¤º */
(function initFromQS(){
  const r = qs.get('room'); const n = qs.get('name');
  if (n) state.name = n;
  if (r){
    state.roomId = r;
    joinRoom(r, n||('ãªãªã—_'+state.myUid.slice(0,4))).then(ref=>{
      state.roomRef = ref; subscribeRoom(); state.screen='room'; render();
    });
  }else{
    state.screen='lobby'; render();
  }
})();
</script>

<!-- SE/BGM ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆå‰å›ã¨åŒã˜ï¼‰ -->
<script>
/* Sound/BGM é–¢é€£ã¯å‰å›ã®ã¾ã¾ï¼ˆçœç•¥ã—ã¦ã‚‚æ©Ÿèƒ½ã¯åŒä¸€ï¼‰ã€‚å¿…è¦ãªã‚‰ã“ã“ã«å‰å›ã®ã‚³ãƒ¼ãƒ‰ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚ */
</script>
</body>
</html>
