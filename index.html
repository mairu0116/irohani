<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>„ÅÑ„Çç„ÅØ„Å´Â•îËµ∞ - „Åø„Çì„Å™„ÅßÊ•Ω„Åó„ÅèÊñáÂ≠óÂΩì„Å¶„Ç≤„Éº„É†ÔºÅ</title>
<link href="https://fonts.googleapis.com/css2?family=Bangers&family=M+PLUS+Rounded+1c:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  /* ===== Theme (brighter, pop, playful) ===== */
  :root{
    --bg:#0b0f2a;           /* base background */
    --bg2:#0e1540;          /* card background */
    --ink:#f4f7ff;          /* primary text */
    --muted:#b7c3ff;        /* hint text */
    --ok:#44d7b6;           /* success */
    --warn:#ffd166;         /* warning */
    --err:#ff6b6b;          /* error */
    --accent:#7aa2ff;       /* accent */
    --accent2:#ff72d2;      /* secondary accent */
    --glow: 0 0 18px rgba(122,162,255,.35), 0 0 36px rgba(255,114,210,.15);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink); font-family:"M PLUS Rounded 1c", system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif;
    background: radial-gradient(1200px 800px at 10% -10%, #1a2b72 0%, transparent 60%),
                radial-gradient(900px 700px at 110% 20%, #37145f 0%, transparent 60%),
                linear-gradient(180deg, #0a0e25 0%, #0b132e 100%);
    overflow-x:hidden;
  }
  .bg-dots::before{ /* playful floating dots */
    content:""; position:fixed; inset:0; pointer-events:none; opacity:.25; mix-blend-mode:screen;
    background:
      radial-gradient(8px 8px at 10% 20%, #7aa2ff 0 40%, transparent 41%),
      radial-gradient(10px 10px at 70% 10%, #ff72d2 0 40%, transparent 41%),
      radial-gradient(6px 6px at 30% 80%, #44d7b6 0 40%, transparent 41%),
      radial-gradient(9px 9px at 90% 70%, #ffd166 0 40%, transparent 41%);
    animation: floatDots 12s linear infinite;
  }
  @keyframes floatDots{0%{transform:translateY(0)}50%{transform:translateY(-20px)}100%{transform:translateY(0)}}

  .container{max-width:1100px;margin:0 auto;padding:24px}

  header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin:4px 0 16px}
  .logo{display:flex; gap:10px; align-items:center}
  .logo-emoji{font-size:28px; filter: drop-shadow(0 2px 6px rgba(255,255,255,.15));}
  h1{margin:0; font-family:"Bangers", system-ui; letter-spacing:.5px; font-size:42px; line-height:1; 
     background: linear-gradient(95deg, #7aa2ff 10%, #ff72d2 55%, #44d7b6 100%);
     -webkit-background-clip:text; background-clip:text; color:transparent; text-shadow: 0 0 0 rgba(0,0,0,0);
  }
  .subtitle{margin-top:4px; color:var(--muted); font-size:12px}

  .panel{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
         border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:16px; margin:12px 0; box-shadow: var(--glow);}

  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .grid{display:grid;gap:14px}
  .cols-2{grid-template-columns:1fr 1fr}
  .cols-3{grid-template-columns:repeat(3, 1fr)}
  @media (max-width:900px){ .cols-3{grid-template-columns:1fr} }

  input,button{background:#0f1730;color:var(--ink);border:1px solid rgba(255,255,255,.22);border-radius:12px;padding:12px 14px}
  input{min-width:220px}
  button{cursor:pointer;font-weight:800;letter-spacing:.3px; transition: transform .08s ease, filter .12s ease, box-shadow .12s ease}
  button:active{transform:translateY(1px) scale(.99)}
  .primary{background:linear-gradient(135deg,#5c86ff,#3fb4ff);border:none; box-shadow: 0 6px 18px rgba(63,180,255,.3)}
  .danger{background:linear-gradient(135deg,#ff6b6b,#f78ca0);border:none; box-shadow: 0 6px 18px rgba(247,140,160,.25)}
  .success{background:linear-gradient(135deg,#44d7b6,#6be6c1);border:none; box-shadow: 0 6px 18px rgba(68,215,182,.25)}
  .ghost{background:transparent}
  .primary:hover,.danger:hover,.success:hover{filter: brightness(1.05)}

  .hint{color:var(--muted);font-size:13px;margin-top:6px}
  .kbd{border:1px solid rgba(255,255,255,.3);padding:2px 6px;border-radius:6px;background:rgba(255,255,255,.08);font-family:ui-monospace,monospace;font-size:12px}
  .pill{font-size:11px;padding:5px 9px;border-radius:999px;background:#0e1640;border:1px solid rgba(255,255,255,.15);color:var(--muted)}

  .players{display:flex;gap:10px;flex-wrap:wrap}
  .player{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid rgba(255,255,255,.12);border-radius:12px;background:linear-gradient(180deg,#131a3b,#101633)}
  .player.active{outline:2px solid var(--accent); box-shadow: 0 0 0 4px rgba(122,162,255,.18); animation: bump .8s ease}
  .dot{width:10px;height:10px;border-radius:50%; background:linear-gradient(180deg,#5c86ff,#3fb4ff); box-shadow:0 0 0 3px rgba(122,162,255,.25)}
  @keyframes bump{0%{transform:scale(1)}30%{transform:scale(1.06)}100%{transform:scale(1)}}

  .board{display:grid;grid-template-columns:repeat(10,1fr);gap:8px}
  .tile{position:relative; padding:12px 0;text-align:center;border:1px solid rgba(255,255,255,.15);border-radius:12px;user-select:none;
        background:linear-gradient(180deg,#142357,#101a36); font-weight:900; letter-spacing:.1em; box-shadow: 0 8px 24px rgba(0,0,0,.25);
        transition: transform .08s ease, box-shadow .12s ease, filter .12s ease, opacity .2s ease}
  .tile.clickable{cursor:pointer; animation: float 2.8s ease-in-out infinite}
  .tile.clickable:hover{transform: translateY(-3px) scale(1.05); box-shadow: 0 10px 28px rgba(122,162,255,.35)}
  .tile.idle{opacity:.65}
  .tile.used{opacity:.35; filter: grayscale(.2)}
  .tile.used::after{content:"Ê∏à"; position:absolute; inset:auto 6px 6px auto; font-size:11px; padding:2px 6px; border-radius:999px; background:#222a55; color:#9fb0ff; border:1px solid rgba(255,255,255,.18)}
  @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-2px)}}

  .cards{display:flex;gap:10px;flex-wrap:wrap}
  .card{width:52px;height:74px;border-radius:12px;border:1px solid rgba(255,255,255,.15);display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#152045,#0f1732);position:relative;
        box-shadow: 0 8px 22px rgba(0,0,0,.35); font-weight:900}
  .card.x{opacity:.75}
  .card.revealed{outline:2px solid var(--ok); box-shadow: 0 0 0 4px rgba(68,215,182,.18)}
  .card.hidden::after{content:"";position:absolute;inset:0;border-radius:12px;background:linear-gradient(145deg,rgba(0,0,0,.5),rgba(0,0,0,.25));}
  .me{outline:2px dashed rgba(122,162,255,.5); padding:12px; border-radius:14px;}

  .footer{margin-top:18px;color:var(--muted);font-size:12px;text-align:center}

  .topic-chip{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; font-weight:800; background:linear-gradient(135deg,#5c86ff,#ff72d2); box-shadow: 0 6px 20px rgba(127,114,255,.28)}
  .topic-chip .emoji{font-size:16px}

  .turn-banner{display:flex; align-items:center; justify-content:center; gap:8px; font-weight:900; padding:10px 12px; border-radius:12px;
    background:linear-gradient(135deg, rgba(122,162,255,.25), rgba(68,215,182,.18)); border:1px solid rgba(255,255,255,.15)}
  .turn-banner .blink{animation: blink 1.2s steps(2,end) infinite}
  @keyframes blink { 50%{opacity:.35} }

  /* My-turn glow on the board */
  .myturn{ box-shadow: 0 0 0 3px rgba(68,215,182,.28) inset, 0 0 32px rgba(68,215,182,.18) }

  /* Toast */
  .toast{position:fixed; top:18px; right:18px; z-index:99; display:flex; flex-direction:column; gap:8px}
  .toast .t{background:#121a32; border:1px solid rgba(255,255,255,.18); padding:10px 12px; border-radius:12px; box-shadow: var(--glow); font-weight:800}
  .t.ok{border-color: rgba(68,215,182,.5)}
  .t.ng{border-color: rgba(255,107,107,.5)}

  /* Canvas overlay for confetti */
  #fx{position:fixed; inset:0; pointer-events:none; z-index:90}
</style>
</head>
<body class="bg-dots">
<div id="fx"></div>
<div class="container">
  <header>
    <div class="logo">
      <div class="logo-emoji">üéÆ‚ú®</div>
      <div>
        <h1>„ÅÑ„Çç„ÅØ„Å´Â•îËµ∞</h1>
        <div class="subtitle">Âèã„Å†„Å°„Å®„ÉØ„Ç§„ÉØ„Ç§ÊñáÂ≠óÂΩì„Å¶Êé®ÁêÜ„Éê„Éà„É´</div>
      </div>
    </div>
  
  <button id="soundToggle" class="pill ghost" title="SEÂàáÊõø">üîä SE ON</button>
</header>

  <div id="app" class="grid"></div>
  <p class="footer">Âêõ„ÅÆÁ¨ëÈ°î„ÅØËºù„ÅÑ„Å¶„ÅÑ„Åü</p>
</div>
<div class="toast" id="toast"></div>

<!-- Firebase CDNÔºà„ÅÇ„Å™„Åü„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆË®≠ÂÆö„Å´Â∑Æ„ÅóÊõø„ÅàÔºâ -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script>
/*** „Åì„Åì„Çí„ÅÇ„Å™„Åü„ÅÆFirebaseÊßãÊàê„Å´ÁΩÆ„ÅçÊèõ„Åà ***/
const firebaseConfig = {
  apiKey: "AIzaSyDxt9FCqPYwGMx1brd1oWOSXxqqeajEkiE",
  authDomain: "irohani-48cf2.firebaseapp.com",
  projectId: "irohani-48cf2",
  storageBucket: "irohani-48cf2.firebasestorage.app",
  messagingSenderId: "917468195405",
  appId: "1:917468195405:web:501559a87a364f67488a04"
};
/*** ‰ª•‰∏ä ***/

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ‰æøÂà©Èñ¢Êï∞ */
const uid = () => localStorage.getItem('irohani_uid') || (localStorage.setItem('irohani_uid', Math.random().toString(36).slice(2,10)), localStorage.getItem('irohani_uid'));
const now = () => Date.now();
const qs = new URLSearchParams(location.search);

/* Toast helpers */
function showToast(msg, ok=true){
  const wrap = document.getElementById('toast');
  const el = document.createElement('div'); el.className = 't ' + (ok ? 'ok' : 'ng');
  el.textContent = msg; wrap.appendChild(el);
  setTimeout(()=>{ el.style.transition='opacity .3s ease, transform .3s ease'; el.style.opacity='0'; el.style.transform='translateY(-6px)'; }, 1500);
  setTimeout(()=> wrap.removeChild(el), 1900);
}

/* Confetti */
function confetti(duration=1800, pieces=140){
  const container = document.getElementById('fx');
  const canvas = document.createElement('canvas'); canvas.width=innerWidth; canvas.height=innerHeight; container.appendChild(canvas);
  const ctx = canvas.getContext('2d');
  const colors = ['#7aa2ff','#ff72d2','#44d7b6','#ffd166','#e6ecff'];
  const P = Array.from({length:pieces}, ()=>({
    x: Math.random()*canvas.width,
    y: -20 - Math.random()*canvas.height*.3,
    w: 6 + Math.random()*6,
    h: 10 + Math.random()*12,
    vx: -1 + Math.random()*2,
    vy: 2 + Math.random()*3.5,
    rot: Math.random()*Math.PI,
    vr: -0.1 + Math.random()*0.2,
    color: colors[Math.floor(Math.random()*colors.length)]
  }));
  let start = performance.now();
  function tick(t){
    const elapsed = t - start; ctx.clearRect(0,0,canvas.width,canvas.height);
    P.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.rot+=p.vr; p.vy += 0.02; if(p.y>canvas.height+30) p.y=-20; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot); ctx.fillStyle=p.color; ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h); ctx.restore(); });
    if (elapsed < duration) requestAnimationFrame(tick); else container.removeChild(canvas);
  }
  requestAnimationFrame(tick);
}

/* „Å≤„Çâ„Åå„Å™Ê≠£Ë¶èÂåñÔºöÊøÅÁÇπ/ÂçäÊøÅÁÇπ„Å™„Åó„ÄÅÂ∞è‚ÜíÂ§ß„ÄÅ„Çπ„Éö„Éº„ÇπÈô§Âéª */
const mapDakuten = Object.fromEntries([
  ['„Åå','„Åã'],['„Åé','„Åç'],['„Åê','„Åè'],['„Åí','„Åë'],['„Åî','„Åì'],
  ['„Åñ','„Åï'],['„Åò','„Åó'],['„Åö','„Åô'],['„Åú','„Åõ'],['„Åû','„Åù'],
  ['„Å†','„Åü'],['„Å¢','„Å°'],['„Å•','„Å§'],['„Åß','„Å¶'],['„Å©','„Å®'],
  ['„Å∞','„ÅØ'],['„Å≥','„Å≤'],['„Å∂','„Åµ'],['„Åπ','„Å∏'],['„Åº','„Åª'],
  ['„Å±','„ÅØ'],['„Å¥','„Å≤'],['„Å∑','„Åµ'],['„Å∫','„Å∏'],['„ÅΩ','„Åª'],
  ['„Çî','„ÅÜ']
]);
const mapSmall = Object.fromEntries([
  ['„ÇÉ','„ÇÑ'],['„ÇÖ','„ÇÜ'],['„Çá','„Çà'],['„Å£','„Å§'],
  ['„ÅÅ','„ÅÇ'],['„ÅÉ','„ÅÑ'],['„ÅÖ','„ÅÜ'],['„Åá','„Åà'],['„Åâ','„Åä']
]);
function toHiragana(s){
  return s.replace(/[\u30a1-\u30f6]/g, c => String.fromCharCode(c.charCodeAt(0)-0x60));
}
function normWord(input){
  let s = (input||'').toString().trim();
  s = toHiragana(s);
  s = s.replace(/\s+/g,'');
  // 1ÊñáÂ≠ó„Åö„Å§Â§âÊèõ
  let out = [];
  for (const ch of s){
    if (mapDakuten[ch]) out.push(mapDakuten[ch]);
    else if (mapSmall[ch]) out.push(mapSmall[ch]);
    else out.push(ch);
  }
  // „Å≤„Çâ„Åå„Å™„ÅÆ„ÅøÔºÜ‰º∏„Å∞„ÅóÊ£í„Äå„Éº„Äç„ÅØOK
  out = out.filter(c => /[„ÅÅ-„Çì„Éº]/.test(c));
  // 2„Äú7„Å´Âèé„ÇÅ„Çã
  if (out.length < 2 || out.length > 7) return null;
  while(out.length < 7) out.push('√ó');
  return out;
}

/* ‰∫îÂçÅÈü≥„Éú„Éº„ÉâÔºàÔºã‰º∏„Å∞„ÅóÊ£íÔºâ */
const BOARD = [
  '„ÅÇ','„ÅÑ','„ÅÜ','„Åà','„Åä',
  '„Åã','„Åç','„Åè','„Åë','„Åì',
  '„Åï','„Åó','„Åô','„Åõ','„Åù',
  '„Åü','„Å°','„Å§','„Å¶','„Å®',
  '„Å™','„Å´','„Å¨','„Å≠','„ÅÆ',
  '„ÅØ','„Å≤','„Åµ','„Å∏','„Åª',
  '„Åæ','„Åø','„ÇÄ','„ÇÅ','„ÇÇ',
  '„ÇÑ','„ÇÜ','„Çà','„Çâ','„Çä',
  '„Çã','„Çå','„Çç','„Çè','„Çí',
  '„Çì','„Éº'
];

/* „ÅäÈ°å */
const TOPICS = [
  'È£≤„Åø„ÇÇ„ÅÆ','„ÅÆ„Çä„ÇÇ„ÅÆ','ÊñáÊàøÂÖ∑','ÂãïÁâ©','ËÅ∑Ê•≠','È£ü„Åπ„ÇÇ„ÅÆ','Êòî„ÅÆ„Åß„Åç„Åî„Å®',
  '„Çπ„Éù„Éº„ÉÑ','„Ç≠„É£„É©„ÇØ„Çø„Éº','Â≠¶Ê†°„Å´„ÅÇ„Çã„ÇÇ„ÅÆ','„ÅÑ„ÅæÈÉ®Â±ã„Å´„ÅÇ„Çã„ÇÇ„ÅÆ',
  '„Ç≥„É≥„Éì„Éã„Å´„ÅÇ„Çã„ÇÇ„ÅÆ','Ë°å„Åç„Åü„ÅÑÂ†¥ÊâÄ','ÊúÄËøëÂá∫„Åã„Åë„ÅüÂ†¥ÊâÄ','ÊúÄËøëÈ£ü„Åπ„Åü„ÇÇ„ÅÆ',
  'ÊúÄËøëË¶ã„Åü„ÇÇ„ÅÆ','ÂÆ∂„Å´„ÅÇ„Çã„ÇÇ„ÅÆ','Ë∫´Ëøë„Å´„ÅÇ„Çã„ÇÇ„ÅÆ','Âª∫Áâ©','ÈáéËèú','„Åè„Å†„ÇÇ„ÅÆ',
  '„ÅäËèìÂ≠ê','„Ç≠„ÉÉ„ÉÅ„É≥Áî®ÂìÅ','ÈõªÂ≠êÊ©üÂô®','Êû∂Á©∫„ÅÆÁîü„ÅçÁâ©','„ÅÑ„ÅæÈ£ü„Åπ„Åü„ÅÑ„ÇÇ„ÅÆ',
  'Âπ¥ÈñìË°å‰∫ã','Êò•„Å®„ÅÑ„Åà„Å∞','Â§è„Å®„ÅÑ„Åà„Å∞','Áßã„Å®„ÅÑ„Åà„Å∞','ÂÜ¨„Å®„ÅÑ„Åà„Å∞',
  '„ÅäÊ≠£Êúà','Â§è‰ºë„Åø','Êµ∑„Å®„ÅÑ„Åà„Å∞','Â±±„Å®„ÅÑ„Åà„Å∞','ÊóÖ„Å´ÊåÅ„Å£„Å¶„ÅÑ„Åè„ÇÇ„ÅÆ',
  'Ê≠å„ÅÆ„Çø„Ç§„Éà„É´','„Ç≤„Éº„É†„ÅÆ„Çø„Ç§„Éà„É´','ÊúâÂêç‰∫∫„ÅÆÂêçÂâç','„Éê„É≥„Éâ„Éª„Ç∞„É´„Éº„Éó„ÅÆÂêçÂâç','‰ºöÁ§æ„ÅÆÂêçÂâç',
  '„ÉÅ„Çß„Éº„É≥Â∫ó„ÅÆÂêçÂâç','Ê≠¶Âô®„ÅÆÂêçÂâç','ÊäÄ„ÅÆÂêçÂâç','Êó•Êú¨„ÅÆË¶≥ÂÖâÂú∞','Êµ∑Â§ñ„ÅÆË¶≥ÂÖâÂú∞',
  '„ÅÇ„ÅÑ„Åï„Å§','ÂÆáÂÆô„Å®„ÅÑ„Åà„Å∞','„ÅäÂºÅÂΩì„ÅÆ„Åä„Åã„Åö','È≠ö‰ªãÈ°û','‰∏≠ËèØÊñôÁêÜ','„Éë„É≥„Å®„ÅÑ„Åà„Å∞',
  'Ê§çÁâ©','Ëô´','Áîü„ÅçÁâ©','ÂØøÂè∏„Éç„Çø','„Åä„ÅÑ„Åó„ÅÑ„ÇÇ„ÅÆ','„Åü„ÅÆ„Åó„ÅÑ„ÇÇ„ÅÆ','„ÇÄ„Åö„Åã„Åó„ÅÑ„ÇÇ„ÅÆ',
  '„Åã„Çè„ÅÑ„ÅÑ„ÇÇ„ÅÆ','„ÅÇ„Åæ„ÅÑ„ÇÇ„ÅÆ','„Å´„Åå„ÅÑ„ÇÇ„ÅÆ',
  'Á¶ÅÊ≠¢„Åï„Çå„Å¶„Çã„ÇÇ„ÅÆ','„ÅÇ„Åü„Åü„Åã„ÅÑ„ÇÇ„ÅÆ','„Å§„ÇÅ„Åü„ÅÑ„ÇÇ„ÅÆ','Ëµ§„ÅÑ„ÇÇ„ÅÆ','Èùí„ÅÑ„ÇÇ„ÅÆ',
  'ÁôΩ„ÅÑ„ÇÇ„ÅÆ','Èªí„ÅÑ„ÇÇ„ÅÆ','Èï∑„ÅÑ„ÇÇ„ÅÆ','Â§ß„Åç„ÅÑ„ÇÇ„ÅÆ','„ÇÑ„Çè„Çâ„Åã„ÅÑ„ÇÇ„ÅÆ','„Å®„Å∂„ÇÇ„ÅÆ',
  '„Åæ„Çè„Çã„ÇÇ„ÅÆ','Ëª¢„Åå„Çã„ÇÇ„ÅÆ','ÊòîÂ•Ω„Åç„Å†„Å£„Åü‰∫∫„ÅÆÂêçÂâç','Â•Ω„Åç„Å™„Çø„Ç§„Éó',
  'Ëá™ÂàÜ„ÇíÂãïÁâ©„Å´‰æã„Åà„Çã„Å®','Ëá™ÂàÜ„ÅÆ„ÅÑ„Å°„Å∞„ÇìÂ§ßÂàá„Å™„ÇÇ„ÅÆ',
  '„Éâ„Ç≠„Éâ„Ç≠„Åô„Çã„ÇÇ„ÅÆ','Ê∞ó„Å´„Å™„Çã„ÇÇ„ÅÆ','ÁÅΩÂÆ≥ÊôÇ„Å´ÂøÖË¶Å„Å™„ÇÇ„ÅÆ'
];
async function setTopic(roomId){
  const topic = TOPICS[Math.floor(Math.random()*TOPICS.length)];
  await db.ref(`rooms/${roomId}/topic`).set(topic);
}
/* ‚ñº ÂÖ•Âäõ‰∏≠„Éâ„É©„Éï„Éà„ÅÆ‰øùÂ≠ò/Âæ©ÂÖÉ */
function draftKey(roomId, uid){ return `irohani_draft_${roomId}_${uid}`; }
function getDraft(roomId, uid){
  try { return localStorage.getItem(draftKey(roomId, uid)) || ''; } catch{ return ''; }
}
function setDraft(roomId, uid, val){
  try { localStorage.setItem(draftKey(roomId, uid), val||''); } catch{}
}
function clearDraft(roomId, uid){
  try { localStorage.removeItem(draftKey(roomId, uid)); } catch{}
}

/* Áä∂ÊÖã */
const state = {
  screen: 'lobby', // lobby | room | game
  roomId: '',
  myUid: uid(),
  name: '',
  roomRef: null,
  roomSnap: null,
  lastSeenAttackTs: 0,
  didConfetti: false,
};

/* „É´„Éº„É†ÊßãÈÄ†
rooms/{roomId} = {
  createdAt, started, topic, currentTurnUid, consec, winnerUid,
  players: {
    uid: { name, word: ['„ÅÇ','„ÅÑ',...,'√ó'], revealed: [false..], locked: false, dropped: false, joinedAt }
  },
  lastAttack: { by, kana, success, ts }
}
*/

async function joinRoom(roomId, name){
  const ref = db.ref(`rooms/${roomId}`);
  const snap = await ref.get();
  if (!snap.exists()){
    await ref.set({
      createdAt: now(), started:false, topic:null, currentTurnUid:null, consec:0, winnerUid:null,
      players:{}, lastAttack:null
    });
  }
  await db.ref(`rooms/${roomId}/players/${state.myUid}`).set({
    name, word:[], revealed:[], locked:false, dropped:false, joinedAt: now()
  });
  return ref;
}

window.addEventListener('beforeunload', ()=>{
  if (state.roomId && state.myUid) {
    db.ref(`rooms/${state.roomId}/players/${state.myUid}`).remove();
  }
});

/* „É´„Éº„É†Ë≥ºË™≠ */
function subscribeRoom(){
  if (!state.roomRef) return;
  state.roomRef.on('value', snap => { state.roomSnap = snap; if (state.screen!=='lobby') render(); });
}

/* „ÅäÈ°åÔºÜÂçòË™û„É≠„ÉÉ„ÇØ */
async function lockWord(roomId, uid, raw){
  const word = normWord(raw);
  if (!word){ alert('2„Äú7ÊñáÂ≠ó„ÅÆ„Å≤„Çâ„Åå„Å™„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàÊøÅÁÇπ/ÂçäÊøÅÁÇπ„Å™„Åó„ÄÅÂ∞èÊñáÂ≠ó„ÅØÂ§ßÊñáÂ≠óÂåñ„ÄÅ‰º∏„Å∞„ÅóÊ£íOKÔºâ'); return; }
  await db.ref(`rooms/${roomId}/players/${uid}`).update({
    word, revealed: new Array(word.length).fill(false), locked:true, dropped:false
  });
}

/* „Ç≤„Éº„É†„Çπ„Çø„Éº„ÉàÔºàÂÖ®Âì°„É≠„ÉÉ„ÇØÂæå„Å´ÂÆüË°åÔºâ */
async function startGame(roomId){
  let started = false, reason = '';
  await db.ref(`rooms/${roomId}`).transaction(room=>{
    if (!room) return room;
    if (room.started) { started = true; return room; }

    const ps = room.players || {};
    const ok2p = Object.values(ps).length>=2;
    const allLocked = Object.values(ps).every(p=>p.locked && (p.word||[]).length===7);
    if (!(ok2p && allLocked)) return room;

    // ‚òÖ „ÅäÈ°å„ÅåÊú™Ë®≠ÂÆö„Å™„Çâ„Åì„Åì„ÅßÊúÄÁµÇÊ±∫ÂÆö
    if (!room.topic){
      room.topic = TOPICS[Math.floor(Math.random()*TOPICS.length)];
    }

    const order = Object.entries(ps).sort((a,b)=> (a[1].joinedAt||0)-(b[1].joinedAt||0));
    room.currentTurnUid = order[0][0];
    room.consec = 0;
    room.started = true;
    room.winnerUid = null;
    room.lastAttack = null;
    room.used = {}; // ‰æã: { '„ÅÇ': true, '„Åã': true, ... }
    for (const [pid,p] of Object.entries(ps)) p.dropped = false;
    
    started = true;
    return room;
  });
  if (!started && reason) alert(reason);
  state.didConfetti = false; // reset visual
}

/* ÊâãÁï™„ÇíÊ¨°„Å∏ */
function nextAliveUid(room){
  const entries = Object.entries(room.players||{}).sort((a,b)=> (a[1].joinedAt||0)-(b[1].joinedAt||0));
  if (!room.currentTurnUid) return entries[0]?.[0]||null;
  const alive = entries.filter(([id,p])=>!p.dropped);
  const idx = alive.findIndex(([id])=> id===room.currentTurnUid);
  if (idx===-1) return alive[0]?.[0]||null;
  return alive[(idx+1)%alive.length]?.[0]||null;
}

/* ËÑ±ËêΩ/ÂãùËÄÖ„ÉÅ„Çß„ÉÉ„ÇØ */
function checkDropAndWinner(room){
  let aliveIds = [];
  for (const [pid,p] of Object.entries(room.players||{})){
    const w = p.word||[];
    const r = p.revealed||[];
    const allOpen = w.every((ch,i)=> ch==='√ó' || r[i]===true);
    if (allOpen) p.dropped = true;
    if (!p.dropped) aliveIds.push(pid);
  }
  if (aliveIds.length===1) room.winnerUid = aliveIds[0];
}

/* ÊîªÊíÉ */
async function attack(roomId, byUid, kana){
  await db.ref(`rooms/${roomId}`).transaction(room=>{
    if (!room?.started || room.winnerUid) return room;
    if (room.currentTurnUid !== byUid) return room;
    if (!BOARD.includes(kana)) return room;

    room.used = room.used || {};
    if (room.used[kana]) return room;   // Êó¢„Å´‰Ωø„Çè„Çå„Å¶„ÅÑ„Åü„ÇâÁÑ°Ë¶ñ

    // ‚òÖ „Åì„Åì„Åß‰ΩøÁî®Ê∏à„Åø„Å´
    room.used[kana] = true;

    let hit = false;
    // ÂÖ®Âì°ÂàÜÂÖ¨ÈñãÂá¶ÁêÜÔºàËá™ÁàÜ„ÇÇ„Åì„Åì„ÅßÔºâ
    for (const [pid,p] of Object.entries(room.players||{})){
      const w = p.word||[];
      const r = p.revealed||[];
      for (let i=0;i<w.length;i++){
        if (!r[i] && w[i]===kana && w[i]!=='√ó'){
          r[i] = true; hit = true;
        }
      }
      p.revealed = r;
    }

    // ËÑ±ËêΩ/ÂãùËÄÖÂà§ÂÆö
    checkDropAndWinner(room);

    // ÈÄ£ÊíÉ/ÊâãÁï™ÈÅ∑Áßª
    if (!hit){
      room.consec = 0;
      room.currentTurnUid = nextAliveUid(room);
    }else{
      if (room.consec===0){
        room.consec = 1; // „ÇÇ„ÅÜ1Âõû
      }else{
        // 2ÂõûÁõÆ„ÇíÁµÇ„Åà„Åü„ÇâÁµÇ‰∫Ü
        room.consec = 0;
        room.currentTurnUid = nextAliveUid(room);
      }
    }

    room.lastAttack = { by: byUid, kana, success: hit, ts: now() };
    return room;
  });
}

/* „É™„Çπ„Çø„Éº„ÉàÔºàÂêå„ÅòÈù¢Â≠ê„ÅßÂÜçÊà¶Ôºâ */
async function restart(roomId){
  await db.ref(`rooms/${roomId}`).transaction(room=>{
    if (!room) return room;
    const ps = room.players||{};
    for (const [pid,p] of Object.entries(ps)){
      p.word=[]; p.revealed=[]; p.locked=false; p.dropped=false;
    }
    room.started=false; room.topic=null; room.currentTurnUid=null; room.consec=0; room.winnerUid=null; room.lastAttack=null;
    room.consec=0; room.winnerUid=null; room.lastAttack=null;
    room.used = {};    
    return room;
  });
  state.didConfetti = false; // visual reset
}

/* ÁîªÈù¢ÊèèÁîª */
const $ = s => document.querySelector(s);

function renderLobby(){
  const root = $('#app'); root.innerHTML='';
  const panel = document.createElement('div'); panel.className='panel grid';

  const name = qs.get('name') || '';
  const room = qs.get('room') || '';
  if (name && !state.name) state.name = name;

  panel.innerHTML = `
    <div class="row"><div class="hint">URL„Å´ <span class="kbd">?room=ROOMID&name=„ÅÇ„Å™„Åü„ÅÆÂêçÂâç</span> „Çí‰ªò„Åë„Å¶ÂÖ±Êúâ„Åô„Çã„Å®ÂÖ•ÂÆ§„ÅåÊ•Ω„Åß„Åô„ÄÇ</div></div>
    <div class="row"><label>„É¶„Éº„Ç∂„ÉºÂêç</label><input id="name" placeholder="‰æãÔºö„Åü„Çç„ÅÜ" value="${state.name||''}" /></div>
    <div class="row"><label>„É´„Éº„É†ID</label><input id="room" placeholder="‰æãÔºöIROHA123" value="${room||''}" /></div>
    <div class="row">
      <button class="primary" id="enter">üö™ ÂÖ•ÂÆ§ / ‰ΩúÊàê</button>
      <span class="hint">Âèã„Å†„Å°„Å´„É´„Éº„É†ID„Çí„Ç∑„Çß„Ç¢„Åó„Çà„ÅÜÔºÅ</span>
    </div>
    <div class="panel">
      <div class="hint"><strong>„É´„Éº„É´Ë¶ÅÁ¥ÑÔºö</strong>„ÅäÈ°å„Å´Ê≤ø„Å£„Åü2„Äú7ÊñáÂ≠ó„ÅÆË®ÄËëâ„Çí„Å≤„Çâ„Åå„Å™„ÅßÔºàÊøÅÁÇπ„Å™„Åó/Â∞èÊñáÂ≠ó‚ÜíÂ§ßÊñáÂ≠ó„ÄÅË∂≥„Çä„Å™„ÅÑÂàÜ√óÔºâ„ÄÇÊâãÁï™„Åß„Éú„Éº„Éâ„ÅÆÊñáÂ≠ó„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÊîªÊíÉ„ÄÇÂêå„ÅòÊñáÂ≠ó„Åå„ÅÇ„Çå„Å∞ÂÖ¨Èñã„ÄÇÊàêÂäü„Å™„Çâ„ÇÇ„ÅÜ1Âõû„Å†„ÅëÈÄ£ÊíÉOK„ÄÇ√ó‰ª•Â§ñ„ÅåÂÖ®ÂÖ¨Èñã„ÅßËÑ±ËêΩ„ÄÅÊúÄÂæå„Åæ„ÅßÊÆã„Å£„Åü‰∫∫„ÅåÂãù„Å°„ÄÇ</div>
    </div>
  `;
  root.appendChild(panel);

  $('#enter').onclick = async ()=>{
    const name = $('#name').value.trim();
    const roomId = $('#room').value.trim();
    if (!name || !roomId){ alert('„É¶„Éº„Ç∂„ÉºÂêç„Å®„É´„Éº„É†ID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
    state.name = name; state.roomId = roomId;
    state.roomRef = await joinRoom(roomId, name);
    subscribeRoom();
    state.screen = 'room'; render();
  };
}

function renderRoom(){
  const root = $('#app'); root.innerHTML='';
  const room = state.roomSnap?.val()||{};
  const topicWrap = document.createElement('div');
  topicWrap.className = 'panel';
  topicWrap.innerHTML = `
    <div class="hint">„ÅäÈ°å</div>
    <div class="topic-chip"><span class="emoji">üéØ</span><span>${room.topic || 'ÔºàÊú™Ë®≠ÂÆöÔºâ'}</span></div>
    <div class="row" style="margin-top:10px">
      <button id="pickTopic" class="ghost"${room.started?' disabled':''}>
        ${room.topic ? 'üé≤ „ÅäÈ°å„ÇíÂÜçÊäΩÈÅ∏' : 'üé≤ „ÅäÈ°å„ÇíÊäΩÈÅ∏'}
      </button>
    </div>
  `;
  root.appendChild(topicWrap);
  setTimeout(()=>{
    const btn = document.getElementById('pickTopic');
    if (btn) btn.onclick = ()=> setTopic(state.roomId);
  });

  const players = Object.entries(room.players||{});
  const listPanel = document.createElement('div'); listPanel.className='panel';
  const list = document.createElement('div'); list.className='players';
  players.forEach(([pid,p])=>{
    const d = document.createElement('div'); d.className='player';
    d.innerHTML = `<span class="dot"></span><strong>${p.name}</strong> <span class="pill">${p.locked?'Ê∫ñÂÇôOK':'Ê∫ñÂÇô‰∏≠'}</span>`;
    list.appendChild(d);
  });
  listPanel.innerHTML = `<h3 style="margin:0 0 8px">ÂÖ•ÂÆ§‰∏≠„ÅÆ„Éó„É¨„Ç§„É§„Éº</h3>`;
  listPanel.appendChild(list);

  const controls = document.createElement('div'); controls.className='row';
  const wordWrap = document.createElement('div'); wordWrap.className='row';
  wordWrap.innerHTML = `<input id="myword" placeholder="„ÅäÈ°å„Å´Ê≤ø„Å£„Å¶2„Äú7ÊñáÂ≠óÔºà‰æãÔºö„Åï„Åã„Å™Ôºâ" style="min-width:260px" /> <button id="lock" class="success">üîí Ë®ÄËëâ„Çí„É≠„ÉÉ„ÇØ</button>`;
  controls.appendChild(wordWrap);

  const start = document.createElement('button'); start.textContent='‚ñ∂ „Ç≤„Éº„É†„Çπ„Çø„Éº„Éà'; start.className='primary';
  start.onclick = ()=> startGame(state.roomId);
  const back = document.createElement('button'); back.textContent='‚Üê „É≠„Éì„Éº„Å∏'; back.className='ghost';
  back.onclick = ()=>{ state.screen='lobby'; render(); };

  const hint = document.createElement('div'); hint.className='hint';
  hint.textContent = 'ÂÖ®Âì°„Åå„ÄåË®ÄËëâ„Çí„É≠„ÉÉ„ÇØ„Äç„Åô„Çã„Å®„Çπ„Çø„Éº„Éà„Åß„Åç„Åæ„Åô„ÄÇ';

  controls.appendChild(start); controls.appendChild(back);

  listPanel.appendChild(controls);
  listPanel.appendChild(hint);
  root.appendChild(listPanel);

  document.getElementById('lock').onclick = ()=>{
    const raw = document.getElementById('myword').value;
    lockWord(state.roomId, state.myUid, raw);
  };

  if (room.started) { state.screen='game'; render(); }
}

function cardNode(ch, revealed, isMe){
  const hidden = !revealed && !isMe;        // Áõ∏Êâã„Åã„Å§Êú™ÂÖ¨Èñã„Å™„ÇâÈö†„Åô
  const div = document.createElement('div');
  const showXStyle = (ch === '√ó') && (isMe || revealed);

  div.className =
    'card' +
    (showXStyle ? ' x' : '') +
    (revealed ? ' revealed' : '') +
    (hidden ? ' hidden' : '');

  // Áõ∏ÊâãÊú™ÂÖ¨Èñã„ÅØÂ∏∏„Å´ÔºüË°®Á§∫
  div.textContent = hidden ? 'Ôºü' : ch;

  return div;
}

function renderGame(){
  const root = $('#app'); root.innerHTML='';
  const room = state.roomSnap?.val(); if (!room) return;

  // Êú™ÈñãÂßã„Å™„Çâ„É´„Éº„É†ÁîªÈù¢„Å∏Êàª„Åô
  if (!room.started) {
    state.screen = 'room';
    render();
    return;
  }

  const me = (room.players||{})[state.myUid]||{};
  const myTurn = room.currentTurnUid===state.myUid && !room.winnerUid;

  /* ‰∏äÊÆµÔºö„ÅäÈ°å„Éª„Çπ„ÉÜ„Éº„Çø„Çπ„ÉªÊìç‰Ωú */
  const top = document.createElement('div'); top.className='grid cols-3';

  const topic = document.createElement('div'); topic.className='panel';
  topic.innerHTML = `<div class="hint">„ÅäÈ°å</div><div class="topic-chip"><span class="emoji">üéØ</span><span>${room.topic||'‚Äî'}</span></div>`;
  top.appendChild(topic);

  const status = document.createElement('div'); status.className='panel';
  if (room.winnerUid){
    status.innerHTML = `<h3 style="color:var(--ok); margin:0 0 6px">üèÜ ÂãùËÄÖÔºö${room.players[room.winnerUid]?.name||'ÔºüÔºüÔºü'}</h3>`;
  }else{
    status.innerHTML = `<div class="turn-banner"><span class="blink">‚è≥</span> ÊâãÁï™Ôºö<strong>${room.players[room.currentTurnUid]?.name||'‚Äî'}</strong> <span class="pill">${room.consec===1?'„ÅÇ„Å®1ÂõûÊîªÊíÉÂèØ':'ÊúÄÂ§ß2ÈÄ£„Åæ„Åß'}</span></div>`;
    if (room.lastAttack){
      const la = room.lastAttack;
      const who = room.players[la.by]?.name||'‚Äî';
      status.innerHTML += `<div class="hint" style="margin-top:8px">Áõ¥ÂâçÔºö${who}„Äå${la.kana}„Äç‚Üí${la.success?'ÊàêÂäü':'Â§±Êïó'}</div>`;

      // Toast for new attack
      if (la.ts && la.ts !== state.lastSeenAttackTs){
        state.lastSeenAttackTs = la.ts;
        showToast(`${who} „Åå„Äå${la.kana}„Äç„ÇíÂÆ£Ë®Ä ‚Äî ${la.success? 'üéØ „ÅÇ„Åü„ÇäÔºÅ' : 'üí• „ÅØ„Åö„Çå‚Ä¶'}`, la.success);
      }
    }
  }
  top.appendChild(status);

  const actions = document.createElement('div'); actions.className='panel';
  const restartBtn = document.createElement('button');
  restartBtn.className='danger';
  restartBtn.textContent='üîÅ „É™„Çπ„Çø„Éº„ÉàÔºàÂêå„ÅòÈù¢Â≠êÔºâ';
  restartBtn.onclick = async ()=>{
    if (confirm('ÊúÄÂàù„Åã„Çâ„ÇÑ„ÇäÁõ¥„Åó„Åæ„Åô„ÅãÔºü')) {
      await restart(state.roomId);
      state.screen = 'room';
      render();
    }
  };
  actions.appendChild(restartBtn);
  actions.appendChild(Object.assign(document.createElement('div'),{className:'hint',innerHTML:'ÊîªÊíÉ„ÅØËá™ÂàÜ„ÅÆÁï™„Å´„Éú„Éº„Éâ„ÅÆÊñáÂ≠ó„Çí„ÇØ„É™„ÉÉ„ÇØ„ÄÇÊàêÂäü„Åô„Çã„Å®„ÇÇ„ÅÜ1Âõû„Å†„ÅëÁ∂ö„Åë„Çâ„Çå„Åæ„ÅôÔºàËá™ÁàÜ„Åß„ÇÇÁ∂öË°åÂèØÔºâ„ÄÇ'}));
  top.appendChild(actions);

  root.appendChild(top);

  /* „Éú„Éº„Éâ */
  const boardWrap = document.createElement('div'); boardWrap.className='panel' + (myTurn ? ' myturn' : '');
  boardWrap.innerHTML = `<h3 style="margin:0 0 8px">Â†¥„ÅÆ„Éú„Éº„Éâ</h3>`;
  const board = document.createElement('div'); board.className='board';

  const usedMap = room.used || {};

  BOARD.forEach(k=>{
    const already = !!usedMap[k];
    const canClick = myTurn && !already;
    const t = document.createElement('div');
    t.className = 'tile ' + (already ? 'used' : (canClick ? 'clickable' : 'idle'));
    t.textContent = k;
    if (canClick){ t.onclick = ()=> attack(state.roomId, state.myUid, k); }
    board.appendChild(t);
  });

  boardWrap.appendChild(board);
  root.appendChild(boardWrap);

  /* ‰ªñ„Éó„É¨„Ç§„É§„Éº */
  const others = document.createElement('div'); others.className='panel';
  others.innerHTML = `<h3 style="margin:0 0 8px">‰ªñ„ÅÆ„Éó„É¨„Ç§„É§„Éº</h3>`;
  const list = document.createElement('div'); list.className='players';
  for (const [pid,p] of Object.entries(room.players||{})){
    if (pid===state.myUid) continue;
    const d = document.createElement('div'); d.className='player'+(p.dropped?'':'');
    if (room.currentTurnUid===pid && !room.winnerUid) d.classList.add('active');
    d.innerHTML = `<span class="dot"></span><strong>${p.name}</strong> ${p.dropped?'<span class="pill">ËÑ±ËêΩ</span>':''}`;
    const hand = document.createElement('div'); hand.className='cards';
    (p.word||[]).forEach((ch,i)=>{ hand.appendChild(cardNode(ch, (p.revealed||[])[i], false)); });
    d.appendChild(hand);
    list.appendChild(d);
  }
  others.appendChild(list);
  root.appendChild(others);

  /* Ëá™ÂàÜ„ÅÆÊâãÊú≠ */
  const mine = document.createElement('div'); mine.className='panel';
  mine.innerHTML = `<h3 style="margin:0 0 8px">Ëá™ÂàÜ„ÅÆÊâãÊú≠</h3>`;
  const myhand = document.createElement('div'); myhand.className='cards me';
  (me.word||[]).forEach((ch,i)=>{ myhand.appendChild(cardNode(ch, (me.revealed||[])[i], true)); });
  mine.appendChild(myhand);
  const hint = document.createElement('div'); hint.className='hint';
  hint.innerHTML = `√ó„ÅØÁ©∫ÁôΩ„Ç´„Éº„Éâ„ÄÇ<br>ÂÖ¨ÈñãÊù°‰ª∂ÔºöÂÆ£Ë®ÄÊñáÂ≠ó„Å´‰∏ÄËá¥„Åó„Åü„Ç´„Éº„ÉâÔºàÂêå„ÅòÊñáÂ≠ó„ÅåË§áÊï∞„ÅÇ„Çå„Å∞ÂÖ®ÈÉ®ÂÖ¨ÈñãÔºâ„ÄÇ√ó‰ª•Â§ñ„ÅåÂÖ®ÈÉ®ÂÖ¨Èñã„ÅßËÑ±ËêΩ„ÄÇ`;
  mine.appendChild(hint);
  root.appendChild(mine);

  // Confetti when win
  if (room.winnerUid && !state.didConfetti){ state.didConfetti = true; confetti(); }
}

function render(){
  if (state.screen==='lobby') return renderLobby();
  if (state.screen==='room') return renderRoom();
  if (state.screen==='game') return renderGame();
}

/* ÂàùÊúüË°®Á§∫ÔºàQS„Åå„ÅÇ„Çå„Å∞Ê¥ªÁî®Ôºâ */
(function initFromQS(){
  const r = qs.get('room'); const n = qs.get('name');
  if (n) state.name = n;
  if (r){
    state.roomId = r;
    joinRoom(r, n||('„Å™„Å™„Åó_'+state.myUid.slice(0,4))).then(ref=>{
      state.roomRef = ref; subscribeRoom(); state.screen='room'; render();
    });
  }else{
    state.screen='lobby'; render();
  }
})();
</script>

<script>
/* === Sound Effects system: mp3‚Üíwav fallback, mute toggle, autoplay unlock, hooks === */
const SILENT_WAV = "data:audio/wav;base64,UklGRiYAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQIAAAAAAA==";

const Sound = {
  master: 0.7,
  enabled: localStorage.getItem('irohani_se') !== 'off',
  unlockOnce: false,
  setEnabled(v){
    this.enabled = v;
    localStorage.setItem('irohani_se', v ? 'on' : 'off');
    const b = document.getElementById('soundToggle');
    if (b) b.textContent = v ? 'üîä SE ON' : 'üîá SE OFF';
  },
  toggle(){ this.setEnabled(!this.enabled); },
  unlock(){
    if (this.unlockOnce) return;
    this.unlockOnce = true;
    const a = new Audio(SILENT_WAV);
    a.volume = 0.001;
    a.play().catch(()=>{});
  }
};

function makeTone(name, volume=1){
  const sources = [`se/${name}.mp3`, `se/${name}.wav`];
  const pool = [];
  function getAudio(){
    let a = pool.find(x => x.ended || x.paused);
    if (!a){
      a = new Audio(sources[0]); a.preload = 'auto';
      a.addEventListener('error', ()=>{
        if (a.src.indexOf('.mp3') !== -1) a.src = sources[1];
      }, { once:true });
      pool.push(a);
    }
    a.volume = volume * Sound.master;
    return a;
  }
  return { play(){ if (!Sound.enabled) return; const a=getAudio(); a.currentTime=0; a.play().catch(()=>{});} };
}

const SE = {
  click: makeTone('click', 0.9),
  start: makeTone('start', 1.0),
  lock:  makeTone('lock',  1.0),
  hit:   makeTone('hit',   1.0),
  miss:  makeTone('miss',  0.9),
  win:   makeTone('win',   1.0),
};

// Unlock on first user interaction
window.addEventListener('pointerdown', ()=> Sound.unlock(), { once:true });

// Initialize toggle button
document.addEventListener('DOMContentLoaded', ()=>{
  const b = document.getElementById('soundToggle');
  if (b){
    b.textContent = Sound.enabled ? 'üîä SE ON' : 'üîá SE OFF';
    b.addEventListener('click', ()=> Sound.toggle());
  }
});

// Hook into existing functions & DOM after each render
(function(){
  const _render = window.render;
  if (typeof _render === 'function'){
    window.render = function(){
      const r = _render.apply(this, arguments);
      setTimeout(hookSEDOM, 0);
      return r;
    };
  } else {
    // Fallback: still try to hook DOM once after load
    window.addEventListener('load', ()=> setTimeout(hookSEDOM, 0));
  }

  // Wrap startGame / restart to play SFX
  if (typeof window.startGame === 'function'){
    const _startGame = window.startGame;
    window.startGame = function(){
      try{ SE.start.play(); }catch(e){}
      return _startGame.apply(this, arguments);
    };
  }
  if (typeof window.restart === 'function'){
    const _restart = window.restart;
    window.restart = function(){
      try{ SE.click.play(); }catch(e){}
      return _restart.apply(this, arguments);
    };
  }

  // Wrap showToast to infer hit/miss SFX
  if (typeof window.showToast === 'function'){
    const _showToast = window.showToast;
    window.showToast = function(msg){
      try{
        const s = String(msg||'');
        if (/[ÊàêÂäü|üéØ|„ÅÇ„Åü„Çä]/.test(s)) SE.hit.play();
        else if (/[Â§±Êïó|„ÅØ„Åö„Çå|üí•]/.test(s)) SE.miss.play();
      }catch(e){}
      return _showToast.apply(this, arguments);
    };
  }

  // Wrap confetti for win SFX
  if (typeof window.confetti === 'function'){
    const _confetti = window.confetti;
    window.confetti = function(){
      try{ SE.win.play(); }catch(e){}
      return _confetti.apply(this, arguments);
    };
  }

  function hookSEDOM(){
    // Generic buttons
    const enter = document.getElementById('enter');
    if (enter && !enter._seBound){
      enter.addEventListener('click', ()=> SE.click.play());
      enter._seBound = true;
    }
    const pick = document.getElementById('pickTopic');
    if (pick && !pick._seBound){
      pick.addEventListener('click', ()=> SE.click.play());
      pick._seBound = true;
    }
    const lockBtn = document.getElementById('lock');
    if (lockBtn && !lockBtn._seBound){
      lockBtn.addEventListener('click', ()=> SE.lock.play());
      lockBtn._seBound = true;
    }
    // Tiles (best-effort)
    document.querySelectorAll('.tile, [data-tile]').forEach(el=>{
      if (!el._seBound){
        el.addEventListener('click', ()=> SE.click.play(), { capture:true });
        el._seBound = true;
      }
    });
  }
})();
</script>

</body>
</html>
