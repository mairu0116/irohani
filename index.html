<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ã„ã‚ã¯ã«å¥”èµ° - ã¿ã‚“ãªã§æ¥½ã—ãæ–‡å­—å½“ã¦ã‚²ãƒ¼ãƒ ï¼</title>
<link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho+B1:wght@400;700;900&family=Yuji+Syuku&display=swap" rel="stylesheet">
<style>
  /* ===== ç”»é¢ãƒ•ã‚£ãƒƒãƒˆç”¨ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ï¼ˆ1920x1080 åŸºæº–ï¼‰ ===== */
  :root{
    --fit-w: 1920;
    --fit-h: 1080;
    --fit-scale: min( calc(100vw / var(--fit-w)), calc(100vh / var(--fit-h)) );

    /* ã‚µã‚¤ã‚ºå¤‰æ•°ï¼ˆ1080påŸºæº–ï¼‰ */
    --container-w: 1760px; /* ã‚¹ãƒ†ãƒ¼ã‚¸æ¨ªå¹… */
    --g-gap: 10px;
    --panel-pad: 12px;
    --font-base: 14px;
    --font-small: 12px;
    --font-h1: 32px;

    --tile: 60px;          /* äº”åéŸ³ã‚¿ã‚¤ãƒ«ã®ä¸€è¾º */
    --rowlabel-w: 76px;    /* è¡Œãƒ©ãƒ™ãƒ«ã®æ¨ªå¹… */
    --tile-gap: 6px;

    --card-w: 46px;        /* æ‰‹æœ­ã‚«ãƒ¼ãƒ‰ã®å¹… */
    --card-h: 66px;        /* æ‰‹æœ­ã‚«ãƒ¼ãƒ‰ã®é«˜ã• */
    --header-h: 84px;      /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã• */
    --toprow-h: 138px;     /* ãƒˆãƒƒãƒ—3ãƒ‘ãƒãƒ«ã®é«˜ã• */
    --board-h: 520px;      /* ç›¤é¢ãƒ‘ãƒãƒ«ã®é«˜ã• */
    --others-h: 260px;     /* ä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ã®é«˜ã• */
    --mine-h: 250px;       /* è‡ªåˆ†ã®æ‰‹æœ­ãƒ‘ãƒãƒ«ã®é«˜ã• */
  }

  /* å…¨ä½“ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ã«åã‚ã¦æ‹¡å¤§ç¸®å° */
  html,body{height:100%}
  body{
    margin:0; overflow:hidden; /* ã¯ã¿å‡ºã—ç¦æ­¢ */
    font-size: var(--font-base);
    background:
      radial-gradient(1100px 780px at 10% -10%, rgba(26,44,66,.06) 0%, transparent 60%),
      radial-gradient(900px 700px at 110% 20%, rgba(179,53,46,.05) 0%, transparent 60%),
      linear-gradient(180deg, #f7f4e9 0%, #f2efe6 100%);
    color:#27231f;
    font-family:"Shippori Mincho B1","Hiragino Mincho ProN","Yu Mincho","Noto Serif JP",serif;
  }

  /* ã‚¹ãƒ†ãƒ¼ã‚¸ï¼šã“ã“ã‚’ 1920x1080 åŸºæº–ã§è¨­è¨ˆã—ã€ç­‰å€æ™‚ã«ãƒ”ãƒƒã‚¿ãƒªåã‚ã‚‹ */
  #stage{
    width: var(--container-w);
    margin: 0 auto;
    padding: 16px;
    transform: scale(var(--fit-scale));
    transform-origin: top center;
    height: calc(var(--fit-h) - 0px); /* ã‚¹ã‚±ãƒ¼ãƒ«å‰ã®è«–ç†é«˜ã• */
  }
  *{box-sizing:border-box}

  .bg-dots::before{
    content:""; position:fixed; inset:0; pointer-events:none; opacity:.14; mix-blend-mode:multiply;
    background:
      radial-gradient(closest-side, rgba(26,44,66,.10) 80%, transparent 81%) 0 0/32px 32px,
      radial-gradient(closest-side, rgba(26,44,66,.10) 80%, transparent 81%) 16px 16px/32px 32px;
  }

  header{
    height: var(--header-h);
    display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px;
  }
  .logo{display:flex; gap:10px; align-items:center}
  .logo-emoji{font-size:22px; filter: drop-shadow(0 1px 0 rgba(255,255,255,.6));}
  h1{margin:0; font-family:"Yuji Syuku", serif; letter-spacing:.06em; font-size:var(--font-h1); line-height:1.1; color:#1a2c42; text-shadow:0 1px 0 rgba(255,255,255,.45)}
  h1::after{content:""; display:block; width:120px; height:6px; margin-top:6px; border-radius:999px;
    background: linear-gradient(90deg, #b3352e, rgba(179,53,46,.45));}
  .subtitle{margin-top:2px; color:#6f675f; font-size: var(--font-small)}

  .pill{font-size:11px;padding:5px 9px;border-radius:999px;background:#efe8d8;border:1px solid rgba(200,164,77,.55);color:#6a5f51}
  input,button{background:rgba(255,255,255,.7);color:#27231f;border:1px solid rgba(39,35,31,.24);border-radius:10px;padding:8px 10px; font-size: var(--font-base)}
  input{min-width:200px; font-family:inherit}
  button{cursor:pointer;font-weight:700;letter-spacing:.05em}
  .primary{background:linear-gradient(180deg, #23384f, #1a2c42); color:#faf7ed; border-color:#132334}
  .danger{background:linear-gradient(180deg, #8f2d27, #7a221d); color:#fff7f2; border-color:#5f1d18}
  .success{background:linear-gradient(180deg, #6a8551, #556e42); color:#f7fff2; border-color:#445c35}
  .ghost{background:transparent}

  .panel{
    background:
      linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,.35)),
      radial-gradient(1200px 800px at 80% -10%, rgba(200,164,77,.08), transparent 60%);
    border:1px solid rgba(39,35,31,.22); border-radius:12px; padding: var(--panel-pad);
    box-shadow: 0 2px 0 rgba(0,0,0,.04), 0 6px 16px rgba(0,0,0,.06);
  }

  .grid{display:grid; gap: var(--g-gap)}
  .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .hint{color:#6f675f; font-size: var(--font-small)}
  .footer{margin-top:8px;color:#6f675f;font-size:11px;text-align:center}

  .players{display:flex;gap:8px;flex-wrap:wrap}
  .player{display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid rgba(39,35,31,.18);border-radius:10px;background:linear-gradient(180deg, #fffdf6, #f4eedf)}
  .player.active{outline:2px solid #c8a44d; box-shadow: 0 0 0 4px rgba(200,164,77,.18)}
  .dot{width:9px;height:9px;border-radius:50%; background:linear-gradient(180deg,#b3352e,#e08378); box-shadow:0 0 0 2px rgba(179,53,46,.18)}

  /* ===== äº”åéŸ³è¡¨ï¼ˆå›ºå®šã‚µã‚¤ã‚ºåŒ–ï¼‰ ===== */
  .board-wrap h3{margin:0 0 6px; font-size:15px}
  .board-grid{
    display:grid;
    grid-template-columns: var(--rowlabel-w) repeat(5, 1fr);
    gap: var(--tile-gap);
    align-items:stretch;
  }
  .head, .rowlabel{
    display:flex; align-items:center; justify-content:center;
    font-weight:900; letter-spacing:.12em; color:#1a2c42;
    background:linear-gradient(180deg,#f6f1de,#efe6cd);
    border:1px solid rgba(39,35,31,.22); border-radius:8px; height: calc(var(--tile) * .82);
  }
  .rowlabel{ background:linear-gradient(180deg,#fffaf0,#f1e5c9); }

  .tile{
    height: var(--tile);
    display:flex; align-items:center; justify-content:center;
    border:1px solid rgba(39,35,31,.22); border-radius:8px; user-select:none;
    background:linear-gradient(180deg,#f0e5cf,#e5d1a0); font-weight:900; letter-spacing:.12em; color:#2a2622;
    text-shadow:0 1px 0 rgba(255,255,255,.65);
  }
  .tile.clickable{cursor:pointer}
  .tile.used{opacity:.45; filter: grayscale(.1)}
  .tile.used::after{content:"æ¸ˆ"; position:absolute; inset:auto 4px 4px auto; font-size:10px; padding:2px 6px; border-radius:999px; background:#fff2ef; color:#b3352e;
    border:1px solid rgba(179,53,46,.45)}
  .tile.placeholder{
    background: repeating-linear-gradient(45deg, rgba(26,44,66,.06) 0 6px, rgba(26,44,66,.02) 6px 12px);
    color:#8b7f71; opacity:.6;
  }

  /* ã‚«ãƒ¼ãƒ‰ã‚’å°å‹åŒ– */
  .cards{display:flex;gap:6px;flex-wrap:wrap}
  .card{width:var(--card-w);height:var(--card-h);border-radius:10px;border:1px solid rgba(39,35,31,.22);display:flex;align-items:center;justify-content:center;
        background:linear-gradient(180deg,#fff8e9,#f1e3cc);position:relative; box-shadow: 0 4px 12px rgba(0,0,0,.16); font-weight:900; color:#27231f}
  .card.x{opacity:.85}
  .card.revealed{outline:2px solid #7b955b; box-shadow: 0 0 0 3px rgba(123,149,91,.18)}
  .card.hidden::after{content:"";position:absolute;inset:0;border-radius:10px;
    background:
      repeating-linear-gradient(45deg, rgba(26,44,66,.1) 0 6px, transparent 6px 12px),
      linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,.35));}
  .me{outline:2px dashed rgba(200,164,77,.5); padding:10px; border-radius:12px;}

  /* ãƒˆãƒƒãƒ—3ãƒ‘ãƒãƒ«ã‚’1è¡Œã« */
  #top-row{display:grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--g-gap); height: var(--toprow-h)}
  #top-row > .panel{height:100%; overflow:hidden}

  /* ãƒœãƒ¼ãƒ‰ï¼ˆå›ºå®šé«˜ï¼‰ */
  #board-row{display:grid; grid-template-columns: 1fr; gap: var(--g-gap); height: var(--board-h)}
  #board-row .panel{height:100%; overflow:hidden}
  #board-row .board-wrap{display:flex; flex-direction:column; height:100%}
  #board-row .board-grid{flex:1; overflow:auto; padding-bottom:2px}

  /* ä¸‹æ®µ2ã‚«ãƒ©ãƒ ï¼ˆä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ / è‡ªåˆ†æ‰‹æœ­ï¼‰ */
  #bottom-row{display:grid; grid-template-columns: 1fr 1fr; gap: var(--g-gap)}
  #others-panel{height: var(--others-h); overflow:auto}
  #mine-panel{height: var(--mine-h); overflow:auto}

  /* ãƒˆãƒ¼ã‚¹ãƒˆãƒ»æ‰‹ç•ªãƒãƒŠãƒ¼ç­‰ å¾®èª¿æ•´ */
  .turn-banner{display:flex; align-items:center; justify-content:center; gap:8px; font-weight:900; padding:8px 10px; border-radius:10px;
    background:linear-gradient(135deg, rgba(111,157,187,.18), rgba(200,164,77,.12)); border:1px solid rgba(26,44,66,.25); color:#1a2c42; font-size:13px}
  .turn-banner .blink{animation: blink 1.2s steps(2,end) infinite}
  @keyframes blink { 50%{opacity:.35} }
  .turn-me{
    position:fixed; top:10px; left:50%; transform:translateX(-50%);
    z-index:95; padding:8px 12px; border-radius:10px; font-weight:900; font-size:13px;
    background:linear-gradient(135deg, rgba(179,53,46,.12), rgba(200,164,77,.18));
    border:1px solid rgba(179,53,46,.45); color:#7a221d;
    box-shadow: 0 6px 18px rgba(0,0,0,.12), 0 0 0 3px rgba(179,53,46,.08);
  }
  body.itsmyturn .board-wrap{ outline:3px solid rgba(179,53,46,.28); outline-offset:2px; }

  .toast{position:fixed; top:14px; right:14px; z-index:99; display:flex; flex-direction:column; gap:6px}
  .toast .t{background:#fbfaf5; border:1px solid rgba(39,35,31,.18); padding:8px 10px; border-radius:10px; box-shadow: 0 4px 12px rgba(0,0,0,.08); font-weight:800; color:#27231f; font-size:13px}
  .t.ok{border-color: rgba(123,149,91,.6)}
  .t.ng{border-color: rgba(160,75,75,.6)}

  #fx{position:fixed; inset:0; pointer-events:none; z-index:90}

  .secret-panel{border:2px dashed rgba(200,164,77,.7); background:rgba(255,255,240,.6)}
  .secret-title{font-weight:900; color:#1a2c42; margin-bottom:6px}

  /* ã¡ã‚‡ã„å°ã•ã‚ã®ãƒ•ã‚©ãƒ³ãƒˆæœ€é©åŒ– */
  .topic-chip{display:inline-flex; align-items:center; gap:8px; padding:7px 10px; border-radius:999px; font-weight:800; color:#fff;
    background:linear-gradient(135deg, #b3352e, #d25a52); border:1px solid rgba(179,53,46,.55);
    box-shadow: 0 3px 12px rgba(179,53,46,.2); font-size:13px}
  .topic-chip .emoji{font-size:15px}

  /* éŸ³é‡ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®æ¨ªå¹…ç¸®å° */
  #bgmVolume{width:110px}
</style>
</head>
<body class="bg-dots">
<div id="fx"></div>

<!-- ===== ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆã“ã“ã‹ã‚‰ä¸‹ãŒ 1920x1080 åŸºæº–ã§ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ï¼‰ ===== -->
<div id="stage">
  <div class="container">
    <header>
      <div class="logo">
        <div class="logo-emoji">ğŸ´ğŸ®</div>
        <div>
          <h1>ã„ã‚ã¯ã«å¥”èµ°</h1>
          <div class="subtitle">ã“ã“ã‚ã®ã‚ã‚Šã‹</div>
        </div>
      </div>

      <div class="row">
        <button id="soundToggle" class="pill ghost" title="SEåˆ‡æ›¿">ğŸ”Š SE ON</button>
        <button id="bgmToggle" class="pill ghost" title="BGMåˆ‡æ›¿">ğŸµ BGM ON</button>
        <input id="bgmVolume" type="range" min="0" max="100" value="50" title="BGMéŸ³é‡">
      </div>
    </header>

    <!-- ===== ç”»é¢æœ¬ä½“ï¼ˆ3æ®µãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰ ===== -->
    <div id="app" class="grid"></div>
    <p class="footer">ã‹ã­ã ã›ï¼</p>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Firebase & App Scriptï¼ˆå‰å›ç‰ˆã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãã®ã¾ã¾è¸è¥²ï¼‰ -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script>
/*** ã“ã“ã‚’ã‚ãªãŸã®Firebaseæ§‹æˆã«ç½®ãæ›ãˆ ***/
const firebaseConfig = {
  apiKey: "AIzaSyDxt9FCqPYwGMx1brd1oWOSXxqqeajEkiE",
  authDomain: "irohani-48cf2.firebaseapp.com",
  projectId: "irohani-48cf2",
  storageBucket: "irohani-48cf2.firebasestorage.app",
  messagingSenderId: "917468195405",
  appId: "1:917468195405:web:501559a87a364f67488a04"
};
/*** ä»¥ä¸Š ***/

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ä¾¿åˆ©é–¢æ•° */
const uid = () => localStorage.getItem('irohani_uid') || (localStorage.setItem('irohani_uid', Math.random().toString(36).slice(2,10)), localStorage.getItem('irohani_uid'));
const now = () => Date.now();
const qs = new URLSearchParams(location.search);

/* Toast helpers */
function showToast(msg, ok=true){
  const wrap = document.getElementById('toast');
  const el = document.createElement('div'); el.className = 't ' + (ok ? 'ok' : 'ng');
  el.textContent = msg; wrap.appendChild(el);
  setTimeout(()=>{ el.style.transition='opacity .3s ease, transform .3s ease'; el.style.opacity='0'; el.style.transform='translateY(-6px)'; }, 1500);
  setTimeout(()=> wrap.removeChild(el), 1900);
}

/* === Endless Confetti === */
let CONFETTI_RAF = 0, CONFETTI_CANVAS = null, CONFETTI_RUNNING = false;
function startConfettiLoop(pieces=120){
  if (CONFETTI_RUNNING) return;
  CONFETTI_RUNNING = true;
  const container = document.getElementById('fx');
  const canvas = document.createElement('canvas'); canvas.width=innerWidth; canvas.height=innerHeight;
  CONFETTI_CANVAS = canvas;
  container.appendChild(canvas);
  const ctx = canvas.getContext('2d');
  const colors = ['#b3352e','#c8a44d','#1a2c42','#6f9dbb','#7b955b','#2a2622'];
  const P = Array.from({length:pieces}, ()=>({
    x: Math.random()*canvas.width,
    y: -20 - Math.random()*canvas.height,
    w: 6 + Math.random()*6,
    h: 10 + Math.random()*12,
    vx: -1 + Math.random()*2,
    vy: 2 + Math.random()*3.5,
    rot: Math.random()*Math.PI,
    vr: -0.1 + Math.random()*0.2,
    color: colors[Math.floor(Math.random()*colors.length)]
  }));
  function step(){
    if (!CONFETTI_RUNNING) return;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    P.forEach(p=>{
      p.x+=p.vx; p.y+=p.vy; p.rot+=p.vr; p.vy += 0.02;
      if (p.y>canvas.height+30){ p.y=-20; p.x=Math.random()*canvas.width; p.vy=2+Math.random()*3.5; }
      if (p.x<-40) p.x=canvas.width+20; if (p.x>canvas.width+40) p.x=-20;
      ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot); ctx.fillStyle=p.color; ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h); ctx.restore();
    });
    CONFETTI_RAF = requestAnimationFrame(step);
  }
  CONFETTI_RAF = requestAnimationFrame(step);
  const onResize = ()=>{ if (!canvas) return; canvas.width=innerWidth; canvas.height=innerHeight; };
  window.addEventListener('resize', onResize);
  canvas._cleanup = ()=> window.removeEventListener('resize', onResize);
}
function stopConfettiLoop(){
  CONFETTI_RUNNING = false;
  if (CONFETTI_RAF) cancelAnimationFrame(CONFETTI_RAF), CONFETTI_RAF=0;
  if (CONFETTI_CANVAS){
    try { CONFETTI_CANVAS._cleanup && CONFETTI_CANVAS._cleanup(); } catch{}
    CONFETTI_CANVAS.parentNode && CONFETTI_CANVAS.parentNode.removeChild(CONFETTI_CANVAS);
    CONFETTI_CANVAS = null;
  }
}

/* ã²ã‚‰ãŒãªæ­£è¦åŒ– */
const mapDakuten = Object.fromEntries([
  ['ãŒ','ã‹'],['ã','ã'],['ã','ã'],['ã’','ã‘'],['ã”','ã“'],
  ['ã–','ã•'],['ã˜','ã—'],['ãš','ã™'],['ãœ','ã›'],['ã','ã'],
  ['ã ','ãŸ'],['ã¢','ã¡'],['ã¥','ã¤'],['ã§','ã¦'],['ã©','ã¨'],
  ['ã°','ã¯'],['ã³','ã²'],['ã¶','ãµ'],['ã¹','ã¸'],['ã¼','ã»'],
  ['ã±','ã¯'],['ã´','ã²'],['ã·','ãµ'],['ãº','ã¸'],['ã½','ã»'],
  ['ã‚”','ã†']
]);
const mapSmall = Object.fromEntries([
  ['ã‚ƒ','ã‚„'],['ã‚…','ã‚†'],['ã‚‡','ã‚ˆ'],['ã£','ã¤'],
  ['ã','ã‚'],['ãƒ','ã„'],['ã…','ã†'],['ã‡','ãˆ'],['ã‰','ãŠ']
]);
function toHiragana(s){
  return s.replace(/[\u30a1-\u30f6]/g, c => String.fromCharCode(c.charCodeAt(0)-0x60));
}
function normWord(input){
  let s = (input||'').toString().trim();
  s = toHiragana(s);
  s = s.replace(/\s+/g,'');
  let out = [];
  for (const ch of s){
    if (mapDakuten[ch]) out.push(mapDakuten[ch]);
    else if (mapSmall[ch]) out.push(mapSmall[ch]);
    else out.push(ch);
  }
  out = out.filter(c => /[ã-ã‚“ãƒ¼]/.test(c));
  if (out.length < 2 || out.length > 7) return null;
  while(out.length < 7) out.push('Ã—');
  return out;
}

/* â–¼ äº”åéŸ³ã‚°ãƒªãƒƒãƒ‰å®šç¾©ï¼ˆè¡Œãƒ©ãƒ™ãƒ«ï¼‹ã‚ã„ã†ãˆãŠï¼‰ */
const VOWELS = ['ã‚','ã„','ã†','ãˆ','ãŠ'];
const ROWS = [
  { label:'ã‚è¡Œ', cells:['ã‚','ã„','ã†','ãˆ','ãŠ'] },
  { label:'ã‹è¡Œ', cells:['ã‹','ã','ã','ã‘','ã“'] },
  { label:'ã•è¡Œ', cells:['ã•','ã—','ã™','ã›','ã'] },
  { label:'ãŸè¡Œ', cells:['ãŸ','ã¡','ã¤','ã¦','ã¨'] },
  { label:'ãªè¡Œ', cells:['ãª','ã«','ã¬','ã­','ã®'] },
  { label:'ã¯è¡Œ', cells:['ã¯','ã²','ãµ','ã¸','ã»'] },
  { label:'ã¾è¡Œ', cells:['ã¾','ã¿','ã‚€','ã‚','ã‚‚'] },
  { label:'ã‚„è¡Œ', cells:['ã‚„',null,'ã‚†',null,'ã‚ˆ'] },
  { label:'ã‚‰è¡Œ', cells:['ã‚‰','ã‚Š','ã‚‹','ã‚Œ','ã‚'] },
  { label:'ã‚è¡Œ', cells:['ã‚',null,null,null,'ã‚’'] },
  { label:'ãã®ä»–', cells:['ã‚“',null,null,null,'ãƒ¼'] },
];

/* ãŠé¡Œ */
const TOPICS = [
  'é£²ã¿ã‚‚ã®','ã®ã‚Šã‚‚ã®','æ–‡æˆ¿å…·','å‹•ç‰©','è·æ¥­','é£Ÿã¹ã‚‚ã®','æ˜”ã®ã§ãã”ã¨',
  'ã‚¹ãƒãƒ¼ãƒ„','ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼','å­¦æ ¡ã«ã‚ã‚‹ã‚‚ã®','ã„ã¾éƒ¨å±‹ã«ã‚ã‚‹ã‚‚ã®',
  'ã‚³ãƒ³ãƒ“ãƒ‹ã«ã‚ã‚‹ã‚‚ã®','è¡ŒããŸã„å ´æ‰€','æœ€è¿‘å‡ºã‹ã‘ãŸå ´æ‰€','æœ€è¿‘é£Ÿã¹ãŸã‚‚ã®',
  'æœ€è¿‘è¦‹ãŸã‚‚ã®','å®¶ã«ã‚ã‚‹ã‚‚ã®','èº«è¿‘ã«ã‚ã‚‹ã‚‚ã®','å»ºç‰©','é‡èœ','ãã ã‚‚ã®',
  'ãŠè“å­','ã‚­ãƒƒãƒãƒ³ç”¨å“','é›»å­æ©Ÿå™¨','æ¶ç©ºã®ç”Ÿãç‰©','ã„ã¾é£Ÿã¹ãŸã„ã‚‚ã®',
  'å¹´é–“è¡Œäº‹','æ˜¥ã¨ã„ãˆã°','å¤ã¨ã„ãˆã°','ç§‹ã¨ã„ãˆã°','å†¬ã¨ã„ãˆã°',
  'ãŠæ­£æœˆ','å¤ä¼‘ã¿','æµ·ã¨ã„ãˆã°','å±±ã¨ã„ãˆã°','æ—…ã«æŒã£ã¦ã„ãã‚‚ã®',
  'æ­Œã®ã‚¿ã‚¤ãƒˆãƒ«','ã‚²ãƒ¼ãƒ ã®ã‚¿ã‚¤ãƒˆãƒ«','æœ‰åäººã®åå‰','ãƒãƒ³ãƒ‰ãƒ»ã‚°ãƒ«ãƒ¼ãƒ—ã®åå‰','ä¼šç¤¾ã®åå‰',
  'ãƒã‚§ãƒ¼ãƒ³åº—ã®åå‰','æ­¦å™¨ã®åå‰','æŠ€ã®åå‰','æ—¥æœ¬ã®è¦³å…‰åœ°','æµ·å¤–ã®è¦³å…‰åœ°',
  'ã‚ã„ã•ã¤','å®‡å®™ã¨ã„ãˆã°','ãŠå¼å½“ã®ãŠã‹ãš','é­šä»‹é¡','ä¸­è¯æ–™ç†','ãƒ‘ãƒ³ã¨ã„ãˆã°',
  'æ¤ç‰©','è™«','ç”Ÿãç‰©','å¯¿å¸ãƒã‚¿','ãŠã„ã—ã„ã‚‚ã®','ãŸã®ã—ã„ã‚‚ã®','ã‚€ãšã‹ã—ã„ã‚‚ã®',
  'ã‹ã‚ã„ã„ã‚‚ã®','ã‚ã¾ã„ã‚‚ã®','ã«ãŒã„ã‚‚ã®',
  'ç¦æ­¢ã•ã‚Œã¦ã‚‹ã‚‚ã®','ã‚ãŸãŸã‹ã„ã‚‚ã®','ã¤ã‚ãŸã„ã‚‚ã®','èµ¤ã„ã‚‚ã®','é’ã„ã‚‚ã®',
  'ç™½ã„ã‚‚ã®','é»’ã„ã‚‚ã®','é•·ã„ã‚‚ã®','å¤§ãã„ã‚‚ã®','ã‚„ã‚ã‚‰ã‹ã„ã‚‚ã®','ã¨ã¶ã‚‚ã®',
  'ã¾ã‚ã‚‹ã‚‚ã®','è»¢ãŒã‚‹ã‚‚ã®','æ˜”å¥½ãã ã£ãŸäººã®åå‰','å¥½ããªã‚¿ã‚¤ãƒ—',
  'è‡ªåˆ†ã‚’å‹•ç‰©ã«ä¾‹ãˆã‚‹ã¨','è‡ªåˆ†ã®ã„ã¡ã°ã‚“å¤§åˆ‡ãªã‚‚ã®',
  'ãƒ‰ã‚­ãƒ‰ã‚­ã™ã‚‹ã‚‚ã®','æ°—ã«ãªã‚‹ã‚‚ã®','ç½å®³æ™‚ã«å¿…è¦ãªã‚‚ã®'
];
async function setTopic(roomId){
  const topic = TOPICS[Math.floor(Math.random()*TOPICS.length)];
  await db.ref(`rooms/${roomId}/topic`).set(topic);
}

/* â–¼ å…¥åŠ›ä¸­ãƒ‰ãƒ©ãƒ•ãƒˆã®ä¿å­˜/å¾©å…ƒ */
function draftKey(roomId, uid){ return `irohani_draft_${roomId}_${uid}`; }
function getDraft(roomId, uid){
  try { return localStorage.getItem(draftKey(roomId, uid)) || ''; } catch{ return ''; }
}
function setDraft(roomId, uid, val){
  try { localStorage.setItem(draftKey(roomId, uid), val||''); } catch{}
}
function clearDraft(roomId, uid){
  try { localStorage.removeItem(draftKey(roomId, uid)); } catch{}
}

/* çŠ¶æ…‹ */
const state = {
  screen: 'lobby',
  roomId: '',
  myUid: uid(),
  name: '',
  roomRef: null,
  roomSnap: null,
  lastSeenAttackTs: 0,
  didConfetti: false,
};

/* ãƒ«ãƒ¼ãƒ æ§‹é€ ã¯å‰ç‰ˆã¨åŒæ§˜ */

async function joinRoom(roomId, name){
  const ref = db.ref(`rooms/${roomId}`);
  const snap = await ref.get();
  if (!snap.exists()){
    await ref.set({
      createdAt: now(), started:false, topic:null, currentTurnUid:null, consec:0, winnerUid:null,
      players:{}, lastAttack:null, used:{}
    });
  }
  await db.ref(`rooms/${roomId}/players/${state.myUid}`).set({
    name, word:[], revealed:[], locked:false, dropped:false, raw:'', joinedAt: now()
  });
  return ref;
}

window.addEventListener('beforeunload', ()=>{
  if (state.roomId && state.myUid) {
    db.ref(`rooms/${state.roomId}/players/${state.myUid}`).remove();
  }
});

function subscribeRoom(){
  if (!state.roomRef) return;
  state.roomRef.on('value', snap => { state.roomSnap = snap; if (state.screen!=='lobby') render(); });
}

/* ãƒ­ãƒƒã‚¯/è§£é™¤ */
async function lockWord(roomId, uid, raw){
  const word = normWord(raw);
  if (!word){ alert('2ã€œ7æ–‡å­—ã®ã²ã‚‰ãŒãªã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆæ¿ç‚¹/åŠæ¿ç‚¹ãªã—ã€å°æ–‡å­—ã¯å¤§æ–‡å­—åŒ–ã€ä¼¸ã°ã—æ£’OKï¼‰'); return; }
  const rawNormalized = word.filter(ch => ch!=='Ã—').join('');
  await db.ref(`rooms/${roomId}/players/${uid}`).update({
    word, revealed: new Array(word.length).fill(false), locked:true, dropped:false, raw: rawNormalized
  });
}
async function unlockWord(roomId, uid){
  await db.ref(`rooms/${roomId}`).transaction(room=>{
    if (!room) return room;
    if (room.started) return room;
    const p = room.players?.[uid];
    if (!p) return room;
    p.word = []; p.revealed = []; p.locked = false; p.dropped = false; p.raw = '';
    return room;
  });
}

/* ã‚¹ã‚¿ãƒ¼ãƒˆãƒ»é€²è¡Œãƒ»å‹æ•—å‡¦ç†ï¼ˆå‰ç‰ˆåŒæ§˜ï¼‰ */
async function startGame(roomId){
  let started = false;
  await db.ref(`rooms/${roomId}`).transaction(room=>{
    if (!room) return room;
    if (room.started) { started = true; return room; }
    const ps = room.players || {};
    const ok2p = Object.values(ps).length>=2;
    const allLocked = Object.values(ps).every(p=>p.locked && (p.word||[]).length===7);
    if (!(ok2p && allLocked)) return room;

    if (!room.topic){
      room.topic = TOPICS[Math.floor(Math.random()*TOPICS.length)];
    }

    const order = Object.entries(ps).sort((a,b)=> (a[1].joinedAt||0)-(b[1].joinedAt||0));
    room.currentTurnUid = order[0][0];
    room.consec = 0;
    room.started = true;
    room.winnerUid = null;
    room.lastAttack = null;
    room.used = {};
    for (const [pid,p] of Object.entries(ps)) p.dropped = false;
    started = true;
    return room;
  });
  state.didConfetti = false;
  stopConfettiLoop();
}
function nextAliveUid(room){
  const entries = Object.entries(room.players||{}).sort((a,b)=> (a[1].joinedAt||0)-(b[1].joinedAt||0));
  if (!room.currentTurnUid) return entries[0]?.[0]||null;
  const alive = entries.filter(([id,p])=>!p.dropped);
  const idx = alive.findIndex(([id])=> id===room.currentTurnUid);
  if (idx===-1) return alive[0]?.[0]||null;
  return alive[(idx+1)%alive.length]?.[0]||null;
}
function checkDropAndWinner(room){
  let aliveIds = [];
  for (const [pid,p] of Object.entries(room.players||{})){
    const w = p.word||[];
    const r = p.revealed||[];
    const allOpen = w.every((ch,i)=> ch==='Ã—' || r[i]===true);
    if (allOpen) p.dropped = true;
    if (!p.dropped) aliveIds.push(pid);
  }
  if (aliveIds.length===1){
    const winner = aliveIds[0];
    room.winnerUid = winner;
    const wp = room.players[winner];
    if (wp){
      const w = wp.word||[];
      wp.revealed = w.map(ch => ch==='Ã—' ? false : true);
    }
  }
}
async function attack(roomId, byUid, kana){
  await db.ref(`rooms/${roomId}`).transaction(room=>{
    if (!room?.started || room.winnerUid) return room;
    if (room.currentTurnUid !== byUid) return room;

    const validSet = new Set(ROWS.flatMap(r=>r.cells).filter(Boolean));
    if (!validSet.has(kana)) return room;

    room.used = room.used || {};
    if (room.used[kana]) return room;
    room.used[kana] = true;

    let hit = false;
    for (const [pid,p] of Object.entries(room.players||{})){
      const w = p.word||[];
      const r = p.revealed||[];
      for (let i=0;i<w.length;i++){
        if (!r[i] && w[i]===kana && w[i]!=='Ã—'){
          r[i] = true; hit = true;
        }
      }
      p.revealed = r;
    }

    checkDropAndWinner(room);

    if (!hit){
      room.consec = 0;
      room.currentTurnUid = nextAliveUid(room);
    }else{
      if (room.consec===0){
        room.consec = 1;
      }else{
        room.consec = 0;
        room.currentTurnUid = nextAliveUid(room);
      }
    }

    room.lastAttack = { by: byUid, kana, success: hit, ts: now() };
    return room;
  });
}
async function restart(roomId){
  await db.ref(`rooms/${roomId}`).transaction(room=>{
    if (!room) return room;
    const ps = room.players||{};
    for (const [pid,p] of Object.entries(ps)){
      p.word=[]; p.revealed=[]; p.locked=false; p.dropped=false; p.raw='';
    }
    room.started=false; room.topic=null; room.currentTurnUid=null; room.consec=0; room.winnerUid=null; room.lastAttack=null;
    room.used = {};
    return room;
  });
  state.didConfetti = false;
  stopConfettiLoop();
}

/* ã‚¿ã‚¤ãƒˆãƒ«/æ‰‹ç•ªã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ */
function updateTurnIndicators(myTurn){
  document.body.classList.toggle('itsmyturn', !!myTurn);
  const baseTitle = 'ã„ã‚ã¯ã«å¥”èµ° - ã¿ã‚“ãªã§æ¥½ã—ãæ–‡å­—å½“ã¦ã‚²ãƒ¼ãƒ ï¼';
  try{ document.title = myTurn ? 'â–¶ ã‚ãªãŸã®æ‰‹ç•ªï¼ - ã„ã‚ã¯ã«å¥”èµ°' : baseTitle; }catch(e){}
  document.querySelectorAll('.turn-me').forEach(n=>n.remove());
  if (myTurn){
    const b = document.createElement('div');
    b.className = 'turn-me';
    b.textContent = 'â–¶ ã‚ãªãŸã®æ‰‹ç•ª';
    document.body.appendChild(b);
  }
}

/* DOM ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
const $ = s => document.querySelector(s);
function cardNode(ch, revealed, isMe){
  const hidden = !revealed && !isMe;
  const div = document.createElement('div');
  const showXStyle = (ch === 'Ã—') && (isMe || revealed);
  div.className = 'card' + (showXStyle ? ' x' : '') + (revealed ? ' revealed' : '') + (hidden ? ' hidden' : '');
  div.textContent = hidden ? 'ï¼Ÿ' : ch;
  return div;
}

/* ç”»é¢æç”»ï¼ˆ1920x1080 å¸ƒç½®ï¼‰ */
function renderLobby(){
  const root = $('#app'); root.innerHTML='';
  const panel = document.createElement('div'); panel.className='panel grid';

  const name = qs.get('name') || '';
  const room = qs.get('room') || '';
  if (name && !state.name) state.name = name;

  panel.innerHTML = `
    <div class="row"><div class="hint">URLã« <span class="pill">?room=ROOMID&name=ã‚ãªãŸã®åå‰</span> ã‚’ä»˜ã‘ã¦å…±æœ‰ã™ã‚‹ã¨å…¥å®¤ãŒæ¥½ã§ã™ã€‚</div></div>
    <div class="row"><label>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label><input id="name" placeholder="ä¾‹ï¼šãŸã‚ã†" value="${state.name||''}" /></div>
    <div class="row"><label>ãƒ«ãƒ¼ãƒ ID</label><input id="room" placeholder="ä¾‹ï¼šIROHA123" value="${room||''}" /></div>
    <div class="row">
      <button class="primary" id="enter">å…¥å®¤ / ä½œæˆ</button>
      <span class="hint">å‹ã ã¡ã«ãƒ«ãƒ¼ãƒ IDã‚’ã‚·ã‚§ã‚¢ã—ã‚ˆã†ã€‚</span>
    </div>
    <div class="panel" style="margin-top:6px">
      <div class="hint"><strong>éŠã³æ–¹ï¼š</strong>ãŠé¡Œã«æ²¿ã£ãŸ2ã€œ7æ–‡å­—ã®è¨€è‘‰ã‚’ã²ã‚‰ãŒãªã§ï¼ˆæ¿ç‚¹ãªã—/å°æ–‡å­—â†’å¤§æ–‡å­—ã€è¶³ã‚Šãªã„åˆ†Ã—ï¼‰ã€‚æ‰‹ç•ªã§ãƒœãƒ¼ãƒ‰ã®æ–‡å­—ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ”»æ’ƒã€‚åŒã˜æ–‡å­—ãŒã‚ã‚Œã°å…¬é–‹ã€‚æˆåŠŸãªã‚‰ã‚‚ã†1å›ã ã‘é€£æ’ƒOKã€‚Ã—ä»¥å¤–ãŒå…¨å…¬é–‹ã§è„±è½ã€æœ€å¾Œã¾ã§æ®‹ã£ãŸäººãŒå‹ã¡ã€‚</div>
    </div>
  `;
  root.appendChild(panel);

  $('#enter').onclick = async ()=>{
    const name = $('#name').value.trim();
    const roomId = $('#room').value.trim();
    if (!name || !roomId){ alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    state.name = name; state.roomId = roomId;
    state.roomRef = await joinRoom(roomId, name);
    subscribeRoom();
    state.screen = 'room'; render();
  };
}

function renderRoom(){
  const root = $('#app'); root.innerHTML='';
  const room = state.roomSnap?.val()||{};
  const me = (room.players||{})[state.myUid] || {};

  if (state.didConfetti && (!room.winnerUid || !room.started)){
    state.didConfetti = false; stopConfettiLoop();
  }
  updateTurnIndicators(false);

  /* ãƒˆãƒƒãƒ—3ãƒ‘ãƒãƒ« */
  const topRow = document.createElement('div'); topRow.id='top-row';

  const topicWrap = document.createElement('div');
  topicWrap.className = 'panel';
  topicWrap.innerHTML = `
    <div class="hint">ãŠé¡Œ</div>
    <div class="topic-chip"><span class="emoji">ğŸ¯</span><span>${room.topic || 'ï¼ˆæœªè¨­å®šï¼‰'}</span></div>
    <div class="row" style="margin-top:6px">
      <button id="pickTopic" class="ghost"${room.started?' disabled':''}>
        ${room.topic ? 'ãŠé¡Œã‚’å†æŠ½é¸' : 'ãŠé¡Œã‚’æŠ½é¸'}
      </button>
    </div>
  `;
  topRow.appendChild(topicWrap);

  const listPanel = document.createElement('div'); listPanel.className='panel';
  listPanel.innerHTML = `<div class="hint" style="margin-bottom:6px"><strong>å…¥å®¤ä¸­</strong></div>`;
  const list = document.createElement('div'); list.className='players';
  Object.entries(room.players||{}).forEach(([pid,p])=>{
    const d = document.createElement('div'); d.className='player';
    d.innerHTML = `<span class="dot"></span><strong>${p.name}</strong> <span class="pill">${p.locked?'æº–å‚™OK':'æº–å‚™ä¸­'}</span>`;
    list.appendChild(d);
  });
  listPanel.appendChild(list);
  topRow.appendChild(listPanel);

  const actionsPanel = document.createElement('div'); actionsPanel.className='panel';
  const controls = document.createElement('div'); controls.className='row';
  const inputDisabled = !!me.locked;
  controls.innerHTML = `
    <input id="myword" placeholder="2ã€œ7æ–‡å­—ï¼ˆä¾‹ï¼šã•ã‹ãªï¼‰" style="min-width:240px" ${inputDisabled?'disabled':''} />
    <button id="lock" class="success" ${inputDisabled?'disabled':''}>è¨€è‘‰ã‚’ãƒ­ãƒƒã‚¯</button>
    ${me.locked && !room.started ? `<button id="unlock" class="ghost">ãƒ­ãƒƒã‚¯è§£é™¤</button>` : ``}
    <button class="primary" id="startBtn">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
  `;
  actionsPanel.appendChild(controls);
  topRow.appendChild(actionsPanel);

  /* ãƒœãƒ¼ãƒ‰æ®µï¼ˆæœªé–‹å§‹æ™‚ã¯ãƒ«ãƒ¼ãƒ ç”»é¢ã ã‘è¡¨ç¤ºï¼‰ */
  const boardRow = document.createElement('div'); boardRow.id='board-row';

  /* æœ¬äººã ã‘ã«ãƒ­ãƒƒã‚¯æ¸ˆã¿å˜èªï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤ºï¼‰ */
  if (me.locked && (me.word||[]).length){
    const secret = document.createElement('div');
    secret.className = 'panel secret-panel';
    const joined = (me.word||[]).filter(ch=>ch!=='Ã—').join('');
    secret.innerHTML = `
      <div class="secret-title">ğŸ”’ ã‚ãªãŸã®ãƒ­ãƒƒã‚¯æ¸ˆã¿å˜èªï¼ˆè‡ªåˆ†ã«ã ã‘è¡¨ç¤ºï¼‰</div>
      <div class="cards me" id="myLockedCards"></div>
      <div class="hint">ç¢ºèªç”¨ï¼š<strong>${joined||'(æœªè¨­å®š)'}</strong></div>
    `;
    setTimeout(()=>{
      const wrap = document.getElementById('myLockedCards');
      (me.word||[]).forEach((ch,i)=> wrap && wrap.appendChild(cardNode(ch, true, true)));
    },0);
    actionsPanel.appendChild(secret);
  }

  const rootFrag = document.createDocumentFragment();
  rootFrag.appendChild(topRow);
  rootFrag.appendChild(boardRow); /* ãƒ«ãƒ¼ãƒ ã§ã¯ç©ºï¼ˆã‚²ãƒ¼ãƒ æ™‚ã®ã¿ä½¿ç”¨ï¼‰ */
  root.appendChild(rootFrag);

  /* ã‚¤ãƒ™ãƒ³ãƒˆ */
  const inputEl = document.getElementById('myword');
  if (inputEl){
    inputEl.value = getDraft(state.roomId, state.myUid);
    inputEl.addEventListener('input', (e)=> setDraft(state.roomId, state.myUid, e.target.value));
  }
  const lockBtn = document.getElementById('lock');
  if (lockBtn){
    lockBtn.onclick = ()=>{
      const raw = document.getElementById('myword').value;
      lockWord(state.roomId, state.myUid, raw).then(()=>{
        clearDraft(state.roomId, state.myUid);
        if (inputEl){ inputEl.value=''; inputEl.disabled = true; }
        lockBtn.disabled = true;
      });
    };
  }
  const unlockBtn = document.getElementById('unlock');
  if (unlockBtn){
    unlockBtn.onclick = async ()=>{
      await unlockWord(state.roomId, state.myUid);
      if (inputEl){ inputEl.disabled = false; inputEl.focus(); }
      showToast('ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¾ã—ãŸ', true);
    };
  }
  const startBtn = document.getElementById('startBtn');
  if (startBtn){ startBtn.onclick = ()=> startGame(state.roomId); }

  if (room.started) { state.screen='game'; render(); }
}

function renderGame(){
  const root = $('#app'); root.innerHTML='';
  const room = state.roomSnap?.val(); if (!room) return;

  if (!room.started) { state.screen = 'room'; render(); return; }

  const me = (room.players||{})[state.myUid]||{};
  const myTurn = room.currentTurnUid===state.myUid && !room.winnerUid;

  if (state.didConfetti && (!room.winnerUid)){
    state.didConfetti = false; stopConfettiLoop();
  }
  updateTurnIndicators(myTurn);

  /* ãƒˆãƒƒãƒ—3ãƒ‘ãƒãƒ« */
  const topRow = document.createElement('div'); topRow.id='top-row';

  const topic = document.createElement('div'); topic.className='panel';
  topic.innerHTML = `<div class="hint">ãŠé¡Œ</div><div class="topic-chip"><span class="emoji">ğŸ¯</span><span>${room.topic||'â€”'}</span></div>`;
  topRow.appendChild(topic);

  const status = document.createElement('div'); status.className='panel';
  if (room.winnerUid){
    status.innerHTML = `<div style="color:#6a8551; font-weight:900; margin-bottom:6px">ğŸ† å‹è€…ï¼š${room.players[room.winnerUid]?.name||'ï¼Ÿï¼Ÿï¼Ÿ'}</div>`;
    if (!state.didConfetti){ state.didConfetti = true; startConfettiLoop(); }
  }else{
    status.innerHTML = `<div class="turn-banner"><span class="blink">â³</span> æ‰‹ç•ªï¼š<strong>${room.players[room.currentTurnUid]?.name||'â€”'}</strong> <span class="pill">${room.consec===1?'ã‚ã¨1å›æ”»æ’ƒå¯':'æœ€å¤§2é€£ã¾ã§'}</span></div>`;
    if (room.lastAttack){
      const la = room.lastAttack;
      const who = room.players[la.by]?.name||'â€”';
      status.innerHTML += `<div class="hint" style="margin-top:6px">ç›´å‰ï¼š${who}ã€Œ${la.kana}ã€â†’${la.success?'æˆåŠŸ':'å¤±æ•—'}</div>`;
      if (la.ts && la.ts !== state.lastSeenAttackTs){
        state.lastSeenAttackTs = la.ts;
        showToast(`${who} ãŒã€Œ${la.kana}ã€ã‚’å®£è¨€ â€” ${la.success? 'ğŸ¯ ã‚ãŸã‚Šï¼' : 'ğŸ’¥ ã¯ãšã‚Œâ€¦'}`, la.success);
      }
    }
  }
  topRow.appendChild(status);

  const actions = document.createElement('div'); actions.className='panel';
  const restartBtn = document.createElement('button');
  restartBtn.className='danger';
  restartBtn.textContent='ğŸ” ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ';
  restartBtn.onclick = async ()=>{
    if (confirm('æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ')) {
      await restart(state.roomId);
      state.screen = 'room';
      render();
    }
  };
  actions.appendChild(restartBtn);
  actions.appendChild(Object.assign(document.createElement('div'),{className:'hint',innerHTML:'æ”»æ’ƒã¯è‡ªåˆ†ã®ç•ªã«ãƒœãƒ¼ãƒ‰ã®æ–‡å­—ã‚’ã‚¯ãƒªãƒƒã‚¯ã€‚æˆåŠŸã™ã‚‹ã¨ã‚‚ã†1å›ã ã‘ç¶šã‘ã‚‰ã‚Œã¾ã™ã€‚'}));
  topRow.appendChild(actions);

  root.appendChild(topRow);

  /* ç›¤é¢ãƒ‘ãƒãƒ«ï¼ˆå›ºå®šé«˜ï¼‹å†…éƒ¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯ï¼‰ */
  const boardRow = document.createElement('div'); boardRow.id='board-row';
  const boardWrap = document.createElement('div'); boardWrap.className='panel board-wrap' + (myTurn ? ' myturn' : '');
  boardWrap.innerHTML = `<h3>å ´ã®ãƒœãƒ¼ãƒ‰ï¼ˆäº”åéŸ³é †ï¼‰</h3>`;
  const grid = document.createElement('div'); grid.className='board-grid';

  // ãƒ˜ãƒƒãƒ€
  const headBlank = document.createElement('div'); headBlank.className='head'; headBlank.textContent='è¡Œ';
  grid.appendChild(headBlank);
  VOWELS.forEach(v=>{
    const h = document.createElement('div'); h.className='head'; h.textContent=v; grid.appendChild(h);
  });

  const usedMap = room.used || {};
  const makeTile = (kana)=>{
    const already = !!usedMap[kana];
    const canClick = myTurn && !already;
    const t = document.createElement('div');
    t.className = 'tile ' + (already ? 'used' : (canClick ? 'clickable' : 'idle'));
    t.textContent = kana;
    if (canClick){ t.onclick = ()=> attack(state.roomId, state.myUid, kana); }
    return t;
  };
  ROWS.forEach(row=>{
    const label = document.createElement('div'); label.className='rowlabel'; label.textContent=row.label;
    grid.appendChild(label);
    row.cells.forEach(cell=>{
      if (!cell){
        const ph = document.createElement('div'); ph.className='tile placeholder'; ph.textContent='â€”';
        grid.appendChild(ph);
      }else{
        grid.appendChild(makeTile(cell));
      }
    });
  });

  boardWrap.appendChild(grid);
  boardRow.appendChild(boardWrap);
  root.appendChild(boardRow);

  /* ä¸‹æ®µï¼šä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ / è‡ªåˆ†æ‰‹æœ­ï¼ˆå›ºå®šé«˜ï¼‹å†…éƒ¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ */
  const bottomRow = document.createElement('div'); bottomRow.id='bottom-row';

  const others = document.createElement('div'); others.className='panel'; others.id='others-panel';
  others.innerHTML = `<div class="hint" style="margin-bottom:6px"><strong>ä»–ã®å¾¡æ–¹</strong></div>`;
  const list = document.createElement('div'); list.className='players';
  for (const [pid,p] of Object.entries(room.players||{})){
    if (pid===state.myUid) continue;
    const d = document.createElement('div'); d.className='player'+(p.dropped?'':'');
    if (room.currentTurnUid===pid && !room.winnerUid) d.classList.add('active');
    d.innerHTML = `<span class="dot"></span><strong>${p.name}</strong> ${p.dropped?'<span class="pill">è„±è½</span>':''}`;
    const hand = document.createElement('div'); hand.className='cards';
    (p.word||[]).forEach((ch,i)=>{ hand.appendChild(cardNode(ch, (p.revealed||[])[i], false)); });
    d.appendChild(hand);
    list.appendChild(d);
  }
  others.appendChild(list);
  bottomRow.appendChild(others);

  const mine = document.createElement('div'); mine.className='panel'; mine.id='mine-panel';
  mine.innerHTML = `<div class="hint" style="margin-bottom:6px"><strong>è‡ªåˆ†ã®æ‰‹æœ­</strong></div>`;
  const myhand = document.createElement('div'); myhand.className='cards me';
  (me.word||[]).forEach((ch,i)=>{ myhand.appendChild(cardNode(ch, (me.revealed||[])[i], true)); });
  mine.appendChild(myhand);
  const hint = document.createElement('div'); hint.className='hint';
  hint.innerHTML = `Ã—ã¯ç©ºç™½ã‚«ãƒ¼ãƒ‰ã€‚<br>å…¬é–‹æ¡ä»¶ï¼šå®£è¨€æ–‡å­—ã«ä¸€è‡´ã—ãŸã‚«ãƒ¼ãƒ‰ï¼ˆåŒã˜æ–‡å­—ãŒè¤‡æ•°ã‚ã‚Œã°å…¨éƒ¨å…¬é–‹ï¼‰ã€‚Ã—ä»¥å¤–ãŒå…¨éƒ¨å…¬é–‹ã§è„±è½ã€‚`;
  mine.appendChild(hint);
  bottomRow.appendChild(mine);

  root.appendChild(bottomRow);
}

function render(){
  if (state.screen==='lobby') return renderLobby();
  if (state.screen==='room') return renderRoom();
  if (state.screen==='game') return renderGame();
}

/* åˆæœŸè¡¨ç¤º */
(function initFromQS(){
  const r = qs.get('room'); const n = qs.get('name');
  if (n) state.name = n;
  if (r){
    state.roomId = r;
    joinRoom(r, n||('ãªãªã—_'+state.myUid.slice(0,4))).then(ref=>{
      state.roomRef = ref; subscribeRoom(); state.screen='room'; render();
    });
  }else{
    state.screen='lobby'; render();
  }
})();
</script>

<script>
/* === Sound Effects systemï¼ˆå‰ç‰ˆã¨åŒæ§˜ï¼‰ === */
const SILENT_WAV = "data:audio/wav;base64,UklGRiYAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQIAAAAAAA==";

const Sound = {
  master: 0.7,
  enabled: localStorage.getItem('irohani_se') !== 'off',
  unlockOnce: false,
  setEnabled(v){
    this.enabled = v;
    localStorage.setItem('irohani_se', v ? 'on' : 'off');
    const b = document.getElementById('soundToggle');
    if (b) b.textContent = v ? 'ğŸ”Š SE ON' : 'ğŸ”‡ SE OFF';
  },
  toggle(){ this.setEnabled(!this.enabled); },
  unlock(){
    if (this.unlockOnce) return;
    this.unlockOnce = true;
    const a = new Audio(SILENT_WAV);
    a.volume = 0.001;
    a.play().catch(()=>{});
  }
};

function makeTone(name, volume=1){
  const sources = [`se/${name}.mp3`, `se/${name}.wav`];
  const pool = [];
  function getAudio(){
    let a = pool.find(x => x.ended || x.paused);
    if (!a){
      a = new Audio(sources[0]); a.preload = 'auto';
      a.addEventListener('error', ()=>{
        if (a.src.indexOf('.mp3') !== -1) a.src = sources[1];
      }, { once:true });
      pool.push(a);
    }
    a.volume = volume * Sound.master;
    return a;
  }
  return { play(){ if (!Sound.enabled) return; const a=getAudio(); a.currentTime=0; a.play().catch(()=>{});} };
}

const SE = {
  click: makeTone('click', 0.9),
  start: makeTone('start', 1.0),
  lock:  makeTone('lock',  1.0),
  hit:   makeTone('hit',   1.0),
  miss:  makeTone('miss',  0.9),
  win:   makeTone('win',   1.0),
};

window.addEventListener('pointerdown', ()=> Sound.unlock(), { once:true });

document.addEventListener('DOMContentLoaded', ()=>{
  const b = document.getElementById('soundToggle');
  if (b){
    b.textContent = Sound.enabled ? 'ğŸ”Š SE ON' : 'ğŸ”‡ SE OFF';
    b.addEventListener('click', ()=> Sound.toggle());
  }
});

/* Hook after render */
(function(){
  const _render = window.render;
  if (typeof _render === 'function'){
    window.render = function(){
      const r = _render.apply(this, arguments);
      setTimeout(hookSEDOM, 0);
      return r;
    };
  } else {
    window.addEventListener('load', ()=> setTimeout(hookSEDOM, 0));
  }

  if (typeof window.startGame === 'function'){
    const _startGame = window.startGame;
    window.startGame = function(){
      try{ SE.start.play(); }catch(e){}
      return _startGame.apply(this, arguments);
    };
  }
  if (typeof window.restart === 'function'){
    const _restart = window.restart;
    window.restart = function(){
      try{ SE.click.play(); }catch(e){}
      return _restart.apply(this, arguments);
    };
  }
  if (typeof window.showToast === 'function'){
    const _showToast = window.showToast;
    window.showToast = function(msg){
      try{
        const s = String(msg||'');
        if (/(æˆåŠŸ|ğŸ¯|ã‚ãŸã‚Š)/.test(s)) SE.hit.play();
        else if (/(å¤±æ•—|ã¯ãšã‚Œ|ğŸ’¥)/.test(s)) SE.miss.play();
      }catch(e){}
      return _showToast.apply(this, arguments);
    };
  }

  function hookSEDOM(){
    const enter = document.getElementById('enter');
    if (enter && !enter._seBound){
      enter.addEventListener('click', ()=> SE.click.play());
      enter._seBound = true;
    }
    const pick = document.getElementById('pickTopic');
    if (pick && !pick._seBound){
      pick.addEventListener('click', ()=> SE.click.play());
      pick._seBound = true;
    }
    const lockBtn = document.getElementById('lock');
    if (lockBtn && !lockBtn._seBound){
      lockBtn.addEventListener('click', ()=> SE.lock.play());
      lockBtn._seBound = true;
    }
    document.querySelectorAll('.tile.clickable').forEach(el=>{
      if (!el._seBound){
        el.addEventListener('click', ()=> SE.click.play(), { capture:true });
        el._seBound = true;
      }
    });
  }
})();
</script>

<script>
/* === BGM Controller === */
const BGM = (function(){
  const sources = ['bgm/theme.mp3', 'bgm/theme.wav'];
  let audio = null;
  function ensure(){
    if (audio) return audio;
    audio = new Audio(sources[0]);
    audio.loop = true;
    audio.preload = 'auto';
    audio.volume = 0.5;
    audio.addEventListener('error', ()=>{
      if (audio && audio.src.indexOf('.mp3') !== -1) audio.src = sources[1];
    }, { once:true });
    return audio;
  }
  function playSafely(){
    try{ ensure(); return audio.play(); }catch(e){ return Promise.reject(e); }
  }
  const api = {
    enabled: localStorage.getItem('irohani_bgm') !== 'off',
    setEnabled(v){
      this.enabled = v;
      localStorage.setItem('irohani_bgm', v ? 'on' : 'off');
      const b = document.getElementById('bgmToggle');
      if (b) b.textContent = v ? 'ğŸµ BGM ON' : 'ğŸ”• BGM OFF';
      if (!audio) ensure();
      if (v){ playSafely().catch(()=>{}); } else { try{ audio.pause(); }catch(e){} }
    },
    toggle(){ this.setEnabled(!this.enabled); },
    _unlock(){ if (!audio) ensure(); if (this.enabled){ playSafely().catch(()=>{}); } },
    setVolume(x){ ensure(); audio.volume = Math.max(0, Math.min(1, x)); }
  };
  return api;
})();

/* Unlock tie-in */
(function(){
  const _unlock = Sound.unlock;
  Sound.unlock = function(){
    const r = _unlock.apply(Sound, arguments);
    try{ BGM._unlock(); }catch(e){}
    return r;
  };

  document.addEventListener('DOMContentLoaded', ()=>{
    const b = document.getElementById('bgmToggle');
    if (b){
      b.textContent = BGM.enabled ? 'ğŸµ BGM ON' : 'ğŸ”• BGM OFF';
      b.addEventListener('click', ()=> BGM.toggle());
    }
  });
})();
</script>

<script>
/* BGM volume slider */
document.addEventListener('DOMContentLoaded', ()=>{
  const vol = document.getElementById('bgmVolume');
  if (vol){
    const saved = parseFloat(localStorage.getItem('irohani_bgm_volume'));
    let v = (!isNaN(saved)? saved: 0.5);
    vol.value = Math.round(v*100);
    BGM.setVolume(v);
    vol.addEventListener('input', ()=>{
      const val = vol.value/100;
      BGM.setVolume(val);
      localStorage.setItem('irohani_bgm_volume', val.toFixed(2));
    });
  }
});
</script>

<script>
/* æ—©æœŸãƒœãƒªãƒ¥ãƒ¼ãƒ åæ˜  */
(function(){
  const KEY = 'irohani_bgm_vol';
  let v = parseFloat(localStorage.getItem(KEY));
  if (isNaN(v)) v = 0.5;
  try{ BGM.setVolume(Math.max(0, Math.min(1, v))); }catch(e){}
})();
</script>

</body>
</html>
